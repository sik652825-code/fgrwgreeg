from telethon import TelegramClient, events, Button, types
import logging
from datetime import datetime, timedelta
from telethon.tl.functions.channels import EditBannedRequest
from telethon.tl.types import ChatBannedRights
from telethon.tl.types import PeerUser, User, Channel, ChatAdminRights, PeerChannel
from telethon.tl.functions.channels import EditAdminRequest
from telethon.errors import ChatAdminRequiredError, UserNotParticipantError, ChannelInvalidError
from telethon.tl.types import ChatBannedRights, ChannelParticipantsAdmins, UserStatusRecently, Chat, Channel
import json
import os
import asyncio
import sqlite3
import time
import requests
import random
import re
import hashlib
import uuid
from collections import defaultdict
import sys

# ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
BOT_TOKEN = "8371079711:AAEibNv9L7j7W9noxOmj6bTFPDBOfQdBeek"
API_ID = 23258474
API_HASH = "f5dd3f52675030a650ca2259f9fb79ce"

OWNERS = {
    "—Ö–æ–º—è–∫": {"id": "7557345458", "username": "XOMTG"},
    "–∏–Ω—Å–µ–π–Ω": {"id": "5960170498", "username": None}
}

ADMINS = [7557345458, 5960170498]
OWNER_ID = [7557345458, 5960170498]
LOG_CHANNEL = 'https://t.me/+S1XSJVEMW9g1OWZi'

WELCOME_IMAGE = "https://i.ibb.co/wZ61gwPk/IMG-20251216-230901-226.jpg"
WELCOME_ENABLED = False

# –†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ @WARDREPORT
ROLES = {
    0: {"name": "–ù–µ—Ç –≤ –±–∞–∑–µ üìù", "preview_url": "https://i.ibb.co/tTnCGRH5/IMG-20251218-220105-765.jpg", "scam_chance": 31},
    1: {"name": "–ì–∞—Ä–∞–Ω—Ç üõ°Ô∏è", "preview_url": "https://i.ibb.co/gLXJ061y/IMG-20251218-220907-223.jpg", "scam_chance": 1},
    2: {"name": "–í–æ–∑–º–æ–∂–Ω–æ —Å–∫–∞–º–µ—Ä ‚ö†Ô∏è", "preview_url": "https://i.ibb.co/N6d45hw8/IMG-20251218-215915-862.jpg", "scam_chance": 65},
    3: {"name": "–°–∫–∞–º–µ—Ä ‚ùå", "preview_url": "https://i.ibb.co/bMj3HSV0/IMG-20251218-215910-457.jpg", "scam_chance": 99},
    4: {"name": "–ü–µ—Ç—É—Ö üêì", "preview_url": "https://i.ibb.co/GfNrHMjr/IMG-20251218-215913-756.jpg", "scam_chance": 45},
    5: {"name": "–ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ –Ω–∞ —Å–∫–∞–º ‚ö†Ô∏è", "preview_url": "https://i.ibb.co/N6d45hw8/IMG-20251218-215915-862.jpg", "scam_chance": 51},
    6: {"name": "–°—Ç–∞–∂—ë—Ä üéì", "preview_url": "https://i.ibb.co/fGdQYjXZ/IMG-20251218-215909-496.jpg", "scam_chance": 20},
    7: {"name": "–ê–¥–º–∏–Ω üëÆ", "preview_url": "https://i.ibb.co/LX6vfdM4/IMG-20251218-215928-663.jpg", "scam_chance": 15},
    8: {"name": "–î–∏—Ä–µ–∫—Ç–æ—Ä üëî", "preview_url": "https://i.ibb.co/84PXfL67/IMG-20251218-215925-882.jpg", "scam_chance": 10},
    9: {"name": "–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç üëë", "preview_url": "https://i.ibb.co/7xrvpJrB/IMG-20251218-215906-668.jpg", "scam_chance": 5},
    10: {"name": "–°–æ–∑–¥–∞—Ç–µ–ª—å ‚≠ê", "preview_url": "https://i.ibb.co/395GKLVr/IMG-20251217-215433-120.jpg", "scam_chance": 1},
    11: {"name": "–ö–æ–¥–µ—Ä üíª", "preview_url": "https://i.ibb.co/LX6vfdM4/IMG-20251218-215928-663.jpg", "scam_chance": 3},
    12: {"name": "–ü—Ä–æ–≤–µ—Ä–µ–Ω –≥–∞—Ä–∞–Ω—Ç–æ–º ‚úÖ", "preview_url": "https://i.ibb.co/3XxfZ8F/photo-2025-06-20-10-22-38-2.jpg", "scam_chance": 5},
    13: {"name": "–ê–π–¥–æ—à‚≠ê", "preview_url": "https://i.ibb.co/xtQPhT16/image.jpg", "scam_chance": 20}
}

# –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
main_buttons = [
    [Button.text("üé≠ –ü—Ä–æ—Ñ–∏–ª—å", resize=True)],
    [Button.text("‚úÖ –ì–∞—Ä–∞–Ω—Ç—ã –±–∞–∑—ã", resize=True), Button.text("üë®‚Äçüéì –í–æ–ª–æ–Ω—Ç—ë—Ä—ã –±–∞–∑—ã", resize=True)],
    [Button.text("üî∞ –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", resize=True), Button.text("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑—ã", resize=True)],
    [Button.text("üîì –ü—Ä–µ–º–∏—É–º", resize=True), Button.text("‚ùì –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã", resize=True)],
    [Button.text("üö´ –°–ª–∏—Ç—å —Å–∫–∞–º–º–µ—Ä–∞!", resize=True)],
    [Button.text("üîó –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Å—ã–ª–∫—É", resize=True)]
]

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO,
    handlers=[
        logging.FileHandler('ward_bot.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
user_scammers_count = {}
user_states = {}
checks_count = 0
last_check_time = {}
joined_users_cache = set()
admin_cooldowns = {}
guarantor_cooldowns = {}
user_message_count = defaultdict(list)
muted_users = {}
games = {}
START_USERS = set()
BOT_CHATS = set()
LAST_CHECKED = {}
TEMP_STORAGE = {}

# API –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
IMG_API_KEY = "cb21b904cc405cdfc05731896bc29c64"

# –ü—Ä–∞–≤–∞ –¥–ª—è –º—É—Ç–∞
MUTE_RIGHTS = ChatBannedRights(
    until_date=None,
    send_messages=True,
    send_media=True,
    send_stickers=True,
    send_gifs=True,
    send_games=True,
    send_inline=True,
)

# –ü—Ä–∞–≤–∞ –¥–ª—è —Ä–∞–∑–º—É—Ç–∞
UNMUTE_RIGHTS = ChatBannedRights(
    until_date=None,
    send_messages=False,
    send_media=False,
    send_stickers=False,
    send_gifs=False,
    send_games=False,
    send_inline=False,
)


class Database:
    def __init__(self, db_name='ward_antiscam.db'):
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö WARD ANTISCAM...")
        self.conn = sqlite3.connect(db_name, check_same_thread=False)
        self.conn.execute("PRAGMA foreign_keys = ON")
        self.conn.row_factory = sqlite3.Row
        self.cursor = self.conn.cursor()
        self.lock = asyncio.Lock()
        self.create_tables()
        self.check_table_structure()

    def create_tables(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        logger.info("–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
        
        # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                user_id INTEGER PRIMARY KEY,
                username TEXT,
                role_id INTEGER DEFAULT 0,
                check_count INTEGER DEFAULT 0,
                last_check_date TEXT,
                country TEXT DEFAULT '–ù–µ —É–∫–∞–∑–∞–Ω–∞',
                channel TEXT,
                custom_photo_url TEXT,
                premium_points INTEGER DEFAULT 0,
                description TEXT,
                scammers_slept INTEGER DEFAULT 0,
                warnings INTEGER DEFAULT 0,
                custom_status TEXT,
                granted_by_id INTEGER,
                curator_id INTEGER,
                allowance INTEGER DEFAULT 0,
                last_spin TEXT,
                premium_expiry TEXT,
                FOREIGN KEY(curator_id) REFERENCES users(user_id)
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS checks (
                check_id INTEGER PRIMARY KEY AUTOINCREMENT,
                checker_id INTEGER,
                target_id INTEGER,
                check_date TEXT DEFAULT CURRENT_TIMESTAMP,
                description TEXT,
                FOREIGN KEY(checker_id) REFERENCES users(user_id),
                FOREIGN KEY(target_id) REFERENCES users(user_id)
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ —Å–∫–∞–º–º–µ—Ä–æ–≤
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS scammers (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER UNIQUE,
                reason TEXT,
                reported_by TEXT,
                description TEXT,
                reporter_id INTEGER,
                scammer_id INTEGER,
                extra_info TEXT,
                unique_id VARCHAR(255),
                FOREIGN KEY(scammer_id) REFERENCES users(user_id)
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS statistics (
                id INTEGER PRIMARY KEY CHECK (id = 1),
                total_messages INTEGER DEFAULT 0,
                total_checks INTEGER DEFAULT 0,
                total_scammers INTEGER DEFAULT 0,
                last_update TEXT DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –í—Å—Ç–∞–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
        self.cursor.execute('''
            INSERT OR IGNORE INTO statistics (id, total_messages, total_checks, total_scammers) 
            VALUES (1, 0, 0, 0)
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS premium_users (
                user_id INTEGER PRIMARY KEY,
                expiry_date TEXT NOT NULL,
                FOREIGN KEY(user_id) REFERENCES users(user_id)
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–∏—á–∏–Ω
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS reasons (
                user_id INTEGER PRIMARY KEY,
                reason TEXT
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –¥–æ–≤–µ—Ä–∏—è
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS trust (
                user_id INTEGER PRIMARY KEY,
                granted_by INTEGER,
                grant_date TEXT
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS messages (
                message_id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
                content TEXT,
                FOREIGN KEY(user_id) REFERENCES users(user_id)
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS additional_reasons (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                additional_reason TEXT,
                FOREIGN KEY(user_id) REFERENCES users(user_id)
            )
        ''')
        
        self.conn.commit()
        logger.info("–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã")

    def check_table_structure(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü"""
        self.cursor.execute("PRAGMA table_info(users);")
        columns = self.cursor.fetchall()
        logger.info("–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã users:")
        for column in columns:
            logger.info(f"  {column[1]}: {column[2]}")

    # ========== –ë–ê–ó–û–í–´–ï –ú–ï–¢–û–î–´ ==========
    
    def user_exists(self, user_id):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        self.cursor.execute("SELECT COUNT(*) FROM users WHERE user_id = ?", (user_id,))
        return self.cursor.fetchone()[0] > 0

    def add_user(self, user_id, username, role_id=0):
        """–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            if not self.user_exists(user_id):
                self.cursor.execute('''
                    INSERT INTO users (user_id, username, role_id, last_check_date)
                    VALUES (?, ?, ?, ?)
                ''', (user_id, username, role_id, datetime.now().isoformat()))
                self.conn.commit()
                logger.info(f"–î–æ–±–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {username} (ID: {user_id}) —Å —Ä–æ–ª—å—é {role_id}")
                return True
            return False
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
            return False

    def get_user(self, user_id):
        """–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        self.cursor.execute('SELECT * FROM users WHERE user_id = ?', (user_id,))
        return self.cursor.fetchone()

    def get_user_role(self, user_id):
        """–ü–æ–ª—É—á–∞–µ—Ç —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user = self.get_user(user_id)
        return user['role_id'] if user else 0

    def update_role(self, user_id, role_id, granted_by_id=None):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            if not self.user_exists(user_id):
                return False
                
            self.cursor.execute('UPDATE users SET role_id = ? WHERE user_id = ?', (role_id, user_id))
            if granted_by_id:
                self.cursor.execute('UPDATE users SET granted_by_id = ? WHERE user_id = ?', (granted_by_id, user_id))
            self.conn.commit()
            logger.info(f"–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ {role_id}")
            return True
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–æ–ª–∏: {e}")
            return False

    def get_check_count(self, user_id):
        """–ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user = self.get_user(user_id)
        return user['check_count'] if user else 0

    def increment_check_count(self, user_id):
        """–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ –ø—Ä–æ–≤–µ—Ä–æ–∫"""
        try:
            self.cursor.execute(
                'UPDATE users SET check_count = check_count + 1 WHERE user_id = ?',
                (user_id,)
            )
            self.conn.commit()
            logger.info(f"–°—á–µ—Ç—á–∏–∫ –ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–ª—è {user_id} —É–≤–µ–ª–∏—á–µ–Ω")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫: {e}")

    # ========== –°–ö–ê–ú–ú–ï–†–´ ==========
    
    def add_scammer(self, user_id, reason, reported_by, description, unique_id):
        """–î–æ–±–∞–≤–ª—è–µ—Ç —Å–∫–∞–º–º–µ—Ä–∞"""
        try:
            self.cursor.execute('''
                INSERT OR REPLACE INTO scammers 
                (user_id, reason, reported_by, description, unique_id, reporter_id, scammer_id)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            ''', (user_id, reason, reported_by, description, unique_id, reported_by, user_id))
            self.conn.commit()
            logger.info(f"–î–æ–±–∞–≤–ª–µ–Ω —Å–∫–∞–º–º–µ—Ä {user_id}: {reason}")
            return True
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∫–∞–º–º–µ—Ä–∞: {e}")
            return False

    def is_scammer(self, user_id):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–º–º–µ—Ä–æ–º"""
        self.cursor.execute('SELECT COUNT(*) FROM scammers WHERE user_id = ?', (user_id,))
        return self.cursor.fetchone()[0] > 0

    def remove_scammer_status(self, user_id):
        """–£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–∫–∞–º–º–µ—Ä–∞"""
        try:
            self.cursor.execute('DELETE FROM scammers WHERE user_id = ?', (user_id,))
            self.conn.commit()
            logger.info(f"–°—Ç–∞—Ç—É—Å —Å–∫–∞–º–º–µ—Ä–∞ —É–¥–∞–ª–µ–Ω –¥–ª—è {user_id}")
            return True
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–∫–∞–º–º–µ—Ä–∞: {e}")
            return False

    def get_user_scammers_slept(self, user_id):
        """–ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–∏—Ç—ã—Ö —Å–∫–∞–º–º–µ—Ä–æ–≤"""
        user = self.get_user(user_id)
        return user['scammers_slept'] if user else 0

    def increment_scammers_count(self, user_id):
        """–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ —Å–ª–∏—Ç—ã—Ö —Å–∫–∞–º–º–µ—Ä–æ–≤"""
        try:
            self.cursor.execute(
                'UPDATE users SET scammers_slept = scammers_slept + 1 WHERE user_id = ?',
                (user_id,)
            )
            self.conn.commit()
            logger.info(f"–°—á–µ—Ç—á–∏–∫ —Å–∫–∞–º–º–µ—Ä–æ–≤ –¥–ª—è {user_id} —É–≤–µ–ª–∏—á–µ–Ω")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ —Å–∫–∞–º–º–µ—Ä–æ–≤: {e}")

    # ========== –ü–†–ï–ú–ò–£–ú ==========
    
    def add_premium(self, user_id, expiry_date):
        """–î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å"""
        try:
            self.cursor.execute('''
                INSERT OR REPLACE INTO premium_users (user_id, expiry_date)
                VALUES (?, ?)
            ''', (user_id, expiry_date))
            self.conn.commit()
            logger.info(f"–ü—Ä–µ–º–∏—É–º –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è {user_id} –¥–æ {expiry_date}")
            return True
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ–º–∏—É–º–∞: {e}")
            return False

    def is_premium_user(self, user_id):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å"""
        self.cursor.execute(
            'SELECT expiry_date FROM premium_users WHERE user_id = ?',
            (user_id,)
        )
        result = self.cursor.fetchone()
        if result:
            expiry_date = datetime.strptime(result['expiry_date'], "%Y-%m-%d %H:%M:%S")
            return expiry_date > datetime.now()
        return False

    def get_premium_expiry(self, user_id):
        """–ü–æ–ª—É—á–∞–µ—Ç –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–µ–º–∏—É–º–∞"""
        self.cursor.execute(
            'SELECT expiry_date FROM premium_users WHERE user_id = ?',
            (user_id,)
        )
        result = self.cursor.fetchone()
        return result['expiry_date'] if result else None

    def remove_premium(self, user_id):
        """–£–¥–∞–ª—è–µ—Ç –ø—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å"""
        try:
            self.cursor.execute('DELETE FROM premium_users WHERE user_id = ?', (user_id,))
            self.conn.commit()
            logger.info(f"–ü—Ä–µ–º–∏—É–º —É–¥–∞–ª–µ–Ω –¥–ª—è {user_id}")
            return True
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–µ–º–∏—É–º–∞: {e}")
            return False

    # ========== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ==========
    
    def update_total_messages(self, count=1):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π"""
        try:
            self.cursor.execute(
                'UPDATE statistics SET total_messages = total_messages + ?, last_update = ? WHERE id = 1',
                (count, datetime.now().isoformat())
            )
            self.conn.commit()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π: {e}")

    def get_total_messages(self):
        """–ü–æ–ª—É—á–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π"""
        self.cursor.execute('SELECT total_messages FROM statistics WHERE id = 1')
        result = self.cursor.fetchone()
        return result['total_messages'] if result else 0

    def get_statistics(self):
        """–ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
        self.cursor.execute('SELECT * FROM statistics WHERE id = 1')
        stats = self.cursor.fetchone()
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        total_users = self.cursor.execute('SELECT COUNT(*) FROM users').fetchone()[0]
        guarantors = len(self.get_guarantors())
        trainees = len(self.get_trainees())
        scammers = self.cursor.execute('SELECT COUNT(*) FROM scammers').fetchone()[0]
        
        return {
            'total_messages': stats['total_messages'] if stats else 0,
            'total_users': total_users,
            'guarantors': guarantors,
            'trainees': trainees,
            'scammers': scammers,
            'last_update': stats['last_update'] if stats else None
        }

    # ========== –î–†–£–ì–ò–ï –ú–ï–¢–û–î–´ ==========
    
    def update_user(self, user_id, country=None, channel=None, description=None):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            updates = []
            params = []
            
            if country is not None:
                updates.append("country = ?")
                params.append(country)
            if channel is not None:
                updates.append("channel = ?")
                params.append(channel)
            if description is not None:
                updates.append("description = ?")
                params.append(description)
                
            if updates:
                params.append(user_id)
                query = f"UPDATE users SET {', '.join(updates)} WHERE user_id = ?"
                self.cursor.execute(query, params)
                self.conn.commit()
                logger.info(f"–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –æ–±–Ω–æ–≤–ª–µ–Ω—ã")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")

    def get_user_custom_photo(self, user_id):
        """–ü–æ–ª—É—á–∞–µ—Ç –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user = self.get_user(user_id)
        return user['custom_photo_url'] if user else None

    def update_warnings(self, user_id):
        """–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π"""
        try:
            self.cursor.execute(
                'UPDATE users SET warnings = warnings + 1 WHERE user_id = ?',
                (user_id,)
            )
            self.conn.commit()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: {e}")

    def get_warnings_count(self, user_id):
        """–ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π"""
        user = self.get_user(user_id)
        return user['warnings'] if user else 0

    def reset_warnings(self, user_id):
        """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è"""
        try:
            self.cursor.execute(
                'UPDATE users SET warnings = 0 WHERE user_id = ?',
                (user_id,)
            )
            self.conn.commit()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: {e}")

    def get_granted_by(self, user_id):
        """–ü–æ–ª—É—á–∞–µ—Ç ID –≥–∞—Ä–∞–Ω—Ç–∞"""
        user = self.get_user(user_id)
        return user['granted_by_id'] if user else None

    def add_grant(self, user_id, granted_by_id):
        """–î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –æ –≥–∞—Ä–∞–Ω—Ç–∏–∏"""
        try:
            self.cursor.execute('''
                INSERT OR REPLACE INTO trust (user_id, granted_by, grant_date)
                VALUES (?, ?, ?)
            ''', (user_id, granted_by_id, datetime.now().isoformat()))
            self.conn.commit()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≥–∞—Ä–∞–Ω—Ç–∏–∏: {e}")

    def get_premium_points(self, user_id):
        """–ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–µ–º–∏—É–º –ø–æ–∏–Ω—Ç—ã"""
        user = self.get_user(user_id)
        return user['premium_points'] if user else 0

    def add_premium_points(self, user_id, points):
        """–î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–µ–º–∏—É–º –ø–æ–∏–Ω—Ç—ã"""
        try:
            self.cursor.execute(
                'UPDATE users SET premium_points = premium_points + ? WHERE user_id = ?',
                (points, user_id)
            )
            self.conn.commit()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ–º–∏—É–º –ø–æ–∏–Ω—Ç–æ–≤: {e}")

    def get_guarantors(self):
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≥–∞—Ä–∞–Ω—Ç–æ–≤"""
        self.cursor.execute('SELECT user_id FROM users WHERE role_id = 1')
        return [row['user_id'] for row in self.cursor.fetchall()]

    def get_trainees(self):
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å—Ç–∞–∂–µ—Ä–æ–≤"""
        self.cursor.execute('SELECT user_id FROM users WHERE role_id = 6')
        return [row['user_id'] for row in self.cursor.fetchall()]

    def get_verified_users(self):
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        self.cursor.execute('SELECT user_id FROM users WHERE role_id = 12')
        return [row['user_id'] for row in self.cursor.fetchall()]

    def update_description(self, user_id, description):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            self.cursor.execute(
                'UPDATE users SET description = ? WHERE user_id = ?',
                (description, user_id)
            )
            self.conn.commit()
            logger.info(f"–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –æ–±–Ω–æ–≤–ª–µ–Ω–æ")
            return True
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è: {e}")
            return False

    def add_additional_reason(self, user_id, additional_reason):
        """–î–æ–±–∞–≤–ª—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–∏—á–∏–Ω—É"""
        try:
            self.cursor.execute('''
                INSERT INTO additional_reasons (user_id, additional_reason)
                VALUES (?, ?)
            ''', (user_id, additional_reason))
            self.conn.commit()
            logger.info(f"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–ª—è {user_id}")
            return True
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–∏—á–∏–Ω—ã: {e}")
            return False

    def close(self):
        """–ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î"""
        self.conn.close()
        logger.info("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î –∑–∞–∫—Ä—ã—Ç–æ")


# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –±–æ—Ç–∞
db = Database()
bot = TelegramClient('ward_antiscam.session', API_ID, API_HASH).start(bot_token=BOT_TOKEN)


# ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========

async def send_response(event, text, buttons=None, parse_mode='md', link_preview=False):
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞"""
    try:
        if buttons:
            return await event.respond(text, buttons=buttons, parse_mode=parse_mode, link_preview=link_preview)
        else:
            return await event.respond(text, parse_mode=parse_mode, link_preview=link_preview)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        return None


async def get_user_profile_response(event, user, user_data):
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å –ø—Ä–æ—Ñ–∏–ª–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id = user.id
    role_id = db.get_user_role(user_id)
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    country = user_data['country'] if user_data and user_data['country'] else "‚ùì"
    channel = user_data['channel'] if user_data and user_data['channel'] else "‚ùì"
    scammers_slept = db.get_user_scammers_slept(user_id)
    checks_count = db.get_check_count(user_id)
    warnings_count = db.get_warnings_count(user_id)
    current_time = datetime.now().strftime("%d.%m.%Y")
    
    # –ü–æ–ª—É—á–∞–µ–º –≥–∞—Ä–∞–Ω—Ç–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
    granted_by_id = db.get_granted_by(user_id)
    granted_by_username = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥–∞—Ä–∞–Ω—Ç"
    if granted_by_id:
        try:
            granted_by_user = await bot.get_entity(granted_by_id)
            granted_by_username = granted_by_user.username if granted_by_user.username else granted_by_user.first_name
        except:
            pass
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–æ—Ñ–∏–ª—è
    if role_id == 0:
        message_text = (
            f"[üë§][ {user.first_name} ](tg://user?id={user_id}) #id{user_id} [‚†Ä]({ROLES[role_id]['preview_url']})\n\n"
            f"[‚ùå] –°—Ç–∞—Ç—É—Å: –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ. –†–∏—Å–∫ —Å–∫–∞–º–∞: **44%**\n"
            f"[‚ÑπÔ∏è] [–£–∑–Ω–∞–π—Ç–µ –æ –≥–∞—Ä–∞–Ω—Ç–∞—Ö](https://telegra.ph/Kto-takoj-GARANT-05-29)\n\n"
            f"[üìç] –†–µ–≥–∏–æ–Ω: {country}\n"
            f"[üö´] –†–∞–∑–æ–±–ª–∞—á–µ–Ω–æ —Å–∫–∞–º–º–µ—Ä–æ–≤: {scammers_slept}\n\n"
            f"[üîí] –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ì–∞—Ä–∞–Ω—Ç–æ–≤ WARD ANTISCAM –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Å–¥–µ–ª–æ–∫.\n\n"
            f"[üìÖ] –î–∞—Ç–∞: {current_time} | üîé–ü—Ä–æ–≤–µ—Ä–æ–∫: {checks_count}\n"
        )
    
    elif role_id == 12:
        message_text = (
            f"[üë§][ {user.first_name} ](tg://user?id={user_id}) #id{user_id} [‚†Ä]({ROLES[role_id]['preview_url']})\n\n"
            f"[‚ùå] –°—Ç–∞—Ç—É—Å: –ü—Ä–æ–≤–µ—Ä–µ–Ω(–∞) –≥–∞—Ä–∞–Ω—Ç–æ–º | [ {granted_by_username} ](tg://user?id={granted_by_id}) ‚úÖ\n"
            f"[‚ÑπÔ∏è] [–£–∑–Ω–∞–π—Ç–µ –æ –≥–∞—Ä–∞–Ω—Ç–∞—Ö](https://telegra.ph/Kto-takoj-GARANT-05-29)\n\n"
            f"[üìç] –†–µ–≥–∏–æ–Ω: {country}\n"
            f"[üö´] –†–∞–∑–æ–±–ª–∞—á–µ–Ω–æ —Å–∫–∞–º–º–µ—Ä–æ–≤: {scammers_slept}\n\n"
            f"[üîí] –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ì–∞—Ä–∞–Ω—Ç–æ–≤ WARD ANTISCAM –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Å–¥–µ–ª–æ–∫.\n\n"
            f"[üìÖ] –î–∞—Ç–∞: {current_time} | üîé–ü—Ä–æ–≤–µ—Ä–æ–∫: {checks_count}\n"
        )
    
    elif role_id == 1:
        custom_photo = db.get_user_custom_photo(user_id)
        preview_url = custom_photo if custom_photo else ROLES[role_id]['preview_url']
        message_text = (
            f"[üë§]({custom_photo})[ {user.first_name} ](tg://user?id={user_id}) #id{user_id} [‚†Ä]({preview_url})\n\n"
            f"[‚úÖ] –°—Ç–∞—Ç—É—Å: –ì–∞—Ä–∞–Ω—Ç\n"
            f"[‚ÑπÔ∏è] [–£–∑–Ω–∞–π—Ç–µ –æ –≥–∞—Ä–∞–Ω—Ç–∞—Ö](https://telegra.ph/Kto-takoj-GARANT-05-29)\n\n"
            f"[üìç] –†–µ–≥–∏–æ–Ω: {country}\n"
            f"[üö´] –†–∞–∑–æ–±–ª–∞—á–µ–Ω–æ —Å–∫–∞–º–º–µ—Ä–æ–≤: {scammers_slept}\n\n"
            f"[üîí] –î–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º –≥–∞—Ä–∞–Ω—Ç–æ–º WARD ANTISCAM\n\n"
            f"[üìÖ] –î–∞—Ç–∞: {current_time} | üîé–ü—Ä–æ–≤–µ—Ä–æ–∫: {checks_count}\n"
        )
    
    elif role_id == 10:
        message_text = (
            f"[üë§][ {user.first_name} ](tg://user?id={user_id}) #id{user_id} [‚†Ä]({ROLES[role_id]['preview_url']})\n\n"
            f"[üí¢] –°—Ç–∞—Ç—É—Å: –í–ª–∞–¥–µ–ª–µ—Ü\n"
            f"[üíñ] [–ü–µ—Ä—Å–æ–Ω–∞–ª WARD ANTISCAM](https://t.me/WARDREPORT)\n\n"
            f"[üìç] –†–µ–≥–∏–æ–Ω: {country}\n"
            f"[üö´] –†–∞–∑–æ–±–ª–∞—á–µ–Ω–æ —Å–∫–∞–º–º–µ—Ä–æ–≤: {scammers_slept}\n\n"
            f"[üîí] –î–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –°–æ–∑–¥–∞—Ç–µ–ª–µ–º –±–∞–∑—ã WARD ANTISCAM\n\n"
            f"[üìÖ] –î–∞—Ç–∞: {current_time} | üîé–ü—Ä–æ–≤–µ—Ä–æ–∫: {checks_count}\n"
        )
    
    elif role_id == 9:
        message_text = (
            f"[üë§][ {user.first_name} ](tg://user?id={user_id}) #id{user_id} [‚†Ä]({ROLES[role_id]['preview_url']})\n\n"
            f"[üßø] –°—Ç–∞—Ç—É—Å: –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç\n"
            f"[üíñ] [–ü–µ—Ä—Å–æ–Ω–∞–ª WARD ANTISCAM](https://t.me/WARDREPORT)\n\n"
            f"[üìç] –†–µ–≥–∏–æ–Ω: {country}\n"
            f"[üö´] –†–∞–∑–æ–±–ª–∞—á–µ–Ω–æ —Å–∫–∞–º–º–µ—Ä–æ–≤: {scammers_slept}\n\n"
            f"[‚ö†] –í—ã–≥–æ–≤–æ—Ä—ã: {warnings_count} "
            f"[üîí] –î–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –Ω–∞–¥—ë–∂–Ω—ã–º –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç–æ–º –±–∞–∑—ã WARD ANTISCAM\n\n"
            f"[üìÖ] –î–∞—Ç–∞: {current_time} | üîé–ü—Ä–æ–≤–µ—Ä–æ–∫: {checks_count}\n"
        )
    
    elif role_id == 3:
        message_text = (
            f"[üë§][ {user.first_name} ](tg://user?id={user_id}) #id{user_id} [‚†Ä]({ROLES[role_id]['preview_url']})\n\n"
            f"[üõë] –°—Ç–∞—Ç—É—Å: –°–∫–∞–º–º–µ—Ä\n\n"
            f"[üìç] –†–µ–≥–∏–æ–Ω: {country}\n"
            f"[üö´] –†–∞–∑–æ–±–ª–∞—á–µ–Ω–æ —Å–∫–∞–º–º–µ—Ä–æ–≤: {scammers_slept}\n\n"
            f"[‚ùå] –î–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è —Å–∫–∞–º–º–µ—Ä–æ–º! –ù–µ –∏–¥–∏—Ç–µ –ø–µ—Ä–≤—ã–º–∏!\n\n"
            f"[üìÖ] –î–∞—Ç–∞: {current_time} | üîé–ü—Ä–æ–≤–µ—Ä–æ–∫: {checks_count}\n"
        )
    
    elif role_id == 7:
        message_text = (
            f"[üë§][ {user.first_name} ](tg://user?id={user_id}) #id{user_id} [‚†Ä]({ROLES[role_id]['preview_url']})\n\n"
            f"[üîç] –°—Ç–∞—Ç—É—Å: –ê–¥–º–∏–Ω\n"
            f"[üíñ] [–ü–µ—Ä—Å–æ–Ω–∞–ª WARD ANTISCAM](https://t.me/WARDREPORT)\n\n"
            f"[üìç] –†–µ–≥–∏–æ–Ω: {country}\n"
            f"[üö´] –†–∞–∑–æ–±–ª–∞—á–µ–Ω–æ —Å–∫–∞–º–º–µ—Ä–æ–≤: {scammers_slept}\n\n"
            f"[‚ö†] –í—ã–≥–æ–≤–æ—Ä—ã: {warnings_count} "
            f"[üîí] –î–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –ë–∞–∑—ã WARD ANTISCAM\n\n"
            f"[üìÖ] –î–∞—Ç–∞: {current_time} | üîé–ü—Ä–æ–≤–µ—Ä–æ–∫: {checks_count}\n"
        )
    
    elif role_id == 6:
        message_text = (
            f"[üë§][ {user.first_name} ](tg://user?id={user_id}) #id{user_id} [‚†Ä]({ROLES[role_id]['preview_url']})\n\n"
            f"[üë®‚Äçüéì] –°—Ç–∞—Ç—É—Å: –°—Ç–∞–∂–µ—Ä\n"
            f"[üíñ] [–ü–µ—Ä—Å–æ–Ω–∞–ª WARD ANTISCAM](https://t.me/WARDREPORT)\n\n"
            f"[üìç] –†–µ–≥–∏–æ–Ω: {country}\n"
            f"[üö´] –†–∞–∑–æ–±–ª–∞—á–µ–Ω–æ —Å–∫–∞–º–º–µ—Ä–æ–≤: {scammers_slept}\n\n"
            f"[‚ö†] –í—ã–≥–æ–≤–æ—Ä—ã: {warnings_count}\n"
            f"[üì£] –ö–∞–Ω–∞–ª: {channel}\n\n"         
            f"[üîí] –î–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –°—Ç–∞–∂—ë—Ä–æ–º –ë–∞–∑—ã WARD ANTISCAM\n\n"
            f"[üìÖ] –î–∞—Ç–∞: {current_time} | üîé–ü—Ä–æ–≤–µ—Ä–æ–∫: {checks_count}\n"
        )
    
    elif role_id == 8:
        message_text = (
            f"[üë§][ {user.first_name} ](tg://user?id={user_id}) #id{user_id} [‚†Ä]({ROLES[role_id]['preview_url']})\n\n"
            f"[‚Äçüé©] –°—Ç–∞—Ç—É—Å: –î–∏—Ä–µ–∫—Ç–æ—Ä\n"
            f"[üíñ] [–ü–µ—Ä—Å–æ–Ω–∞–ª WARD ANTISCAM](https://t.me/WARDREPORT)\n\n"
            f"[üìç] –†–µ–≥–∏–æ–Ω: {country}\n"
            f"[üö´] –†–∞–∑–æ–±–ª–∞—á–µ–Ω–æ —Å–∫–∞–º–º–µ—Ä–æ–≤: {scammers_slept}\n\n"
            f"[‚ö†] –í—ã–≥–æ–≤–æ—Ä—ã: {warnings_count}\n"
            f"[üì£] –ö–∞–Ω–∞–ª: {channel}\n\n"         
            f"[üîí] –î–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –î–∏—Ä–µ–∫—Ç–æ—Ä–æ–º –ë–∞–∑—ã WARD ANTISCAM\n\n"
            f"[üìÖ] –î–∞—Ç–∞: {current_time} | üîé–ü—Ä–æ–≤–µ—Ä–æ–∫: {checks_count}\n"
        )
    
    elif role_id == 11:
        message_text = (
            f"[üë§][ {user.first_name} ](tg://user?id={user_id}) #id{user_id} [‚†Ä]({ROLES[role_id]['preview_url']})\n\n"
            f"[üë®‚Äçüíª] –°—Ç–∞—Ç—É—Å: –ö–æ–¥–µ—Ä\n"
            f"[üíñ] [–ü–µ—Ä—Å–æ–Ω–∞–ª WARD ANTISCAM](https://t.me/WARDREPORT)\n\n"
            f"[üìç] –†–µ–≥–∏–æ–Ω: {country}\n"
            f"[üö´] –†–∞–∑–æ–±–ª–∞—á–µ–Ω–æ —Å–∫–∞–º–º–µ—Ä–æ–≤: {scammers_slept}\n\n"
            f"[‚ö†] –í—ã–≥–æ–≤–æ—Ä—ã: {warnings_count}\n"
            f"[üì£] –ö–∞–Ω–∞–ª: {channel}\n\n"         
            f"[üîí] –î–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º –ë–∞–∑—ã WARD ANTISCAM\n\n"
            f"[üìÖ] –î–∞—Ç–∞: {current_time} | üîé–ü—Ä–æ–≤–µ—Ä–æ–∫: {checks_count}\n"
        )
    
    else:
        message_text = f"[üë§][ {user.first_name} ](tg://user?id={user_id})\n\n–°—Ç–∞—Ç—É—Å: {ROLES[role_id]['name']}\n\n–†–∏—Å–∫ —Å–∫–∞–º–∞: {ROLES[role_id]['scam_chance']}%"
    
    # –ö–Ω–æ–ø–∫–∏
    buttons = [[
        Button.url("üéß –ü—Ä–æ—Ñ–∏–ª—å", f"https://t.me/{user.username}" if user.username else f"tg://user?id={user.id}")
    ]]
    
    return message_text, buttons


async def check_admin(chat_id, user_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"""
    if user_id in ADMINS:
        return True
    
    try:
        chat = await bot.get_entity(chat_id)
        # –î–ª—è —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø
        if hasattr(chat, 'admin_rights'):
            participant = await bot.get_permissions(chat_id, user_id)
            return participant.is_admin
        # –î–ª—è –æ–±—ã—á–Ω—ã—Ö –≥—Ä—É–ø–ø
        elif isinstance(chat, Chat):
            admins = await bot.get_participants(chat_id, filter=ChannelParticipantsAdmins)
            return any(admin.id == user_id for admin in admins)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {e}")
        return False


async def check_chat_type(chat_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–∏–ø —á–∞—Ç–∞"""
    try:
        chat = await bot.get_entity(chat_id)
        
        if isinstance(chat, Channel):
            return "channel"
        elif hasattr(chat, 'megagroup') and chat.megagroup:
            return "supergroup"
        elif isinstance(chat, Chat):
            return "group"
        else:
            return "private"
    except:
        return "unknown"


async def can_use_moderation(chat_id, user_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–∞–≤–∞
    if not await check_admin(chat_id, user_id):
        return False, "–í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≤ —ç—Ç–æ–º —á–∞—Ç–µ"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —á–∞—Ç–∞
    chat_type = await check_chat_type(chat_id)
    
    if chat_type == "private":
        return False, "–ú–æ–¥–µ—Ä–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –±–æ—Ç–∞
    try:
        bot_user = await bot.get_me()
        bot_permissions = await bot.get_permissions(chat_id, bot_user.id)
        
        if not bot_permissions.is_admin:
            return False, "–ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏"
            
        if not bot_permissions.ban_users:
            return False, "–ë–æ—Ç—É –Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∞ –Ω–∞ –±–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
    except:
        return False, "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –±–æ—Ç–∞"
    
    return True, ""


async def mute_user_in_chat(chat_id, user_id, duration_minutes=60, reason=""):
    """–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç–µ"""
    try:
        chat_type = await check_chat_type(chat_id)
        
        if chat_type in ["supergroup", "channel"]:
            # –î–ª—è —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø –∏ –∫–∞–Ω–∞–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–µ—Ç–æ–¥
            until_date = datetime.now() + timedelta(minutes=duration_minutes)
            await bot.edit_permissions(
                chat_id,
                user_id,
                until_date=until_date,
                send_messages=False,
                send_media=False,
                send_stickers=False,
                send_gifs=False,
                send_games=False,
                send_inline=False,
                embed_links=False
            )
        elif chat_type == "group":
            # –î–ª—è –æ–±—ã—á–Ω—ã—Ö –≥—Ä—É–ø–ø - —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥
            try:
                await bot.edit_permissions(
                    chat_id,
                    user_id,
                    until_date=int(time.time() + (duration_minutes * 60)),
                    send_messages=False
                )
            except:
                # –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è, –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
                return False, f"–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–¥–∞—Ç—å –º—É—Ç –≤ –æ–±—ã—á–Ω–æ–π –≥—Ä—É–ø–ø–µ. –í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø—ã."
        else:
            return False, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —á–∞—Ç–∞"
        
        return True, "–ú—É—Ç —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω"
    except ChatAdminRequiredError:
        return False, "–£ –±–æ—Ç–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤"
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –º—É—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        return False, f"–û—à–∏–±–∫–∞: {str(e)}"


async def unmute_user_in_chat(chat_id, user_id):
    """–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–∞–∑–º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç–µ"""
    try:
        chat_type = await check_chat_type(chat_id)
        
        if chat_type in ["supergroup", "channel"]:
            await bot.edit_permissions(
                chat_id,
                user_id,
                send_messages=True,
                send_media=True,
                send_stickers=True,
                send_gifs=True,
                send_games=True,
                send_inline=True,
                embed_links=True
            )
        elif chat_type == "group":
            try:
                await bot.edit_permissions(
                    chat_id,
                    user_id,
                    send_messages=True
                )
            except:
                return False, "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å –º—É—Ç –≤ –æ–±—ã—á–Ω–æ–π –≥—Ä—É–ø–ø–µ"
        else:
            return False, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —á–∞—Ç–∞"
        
        return True, "–†–∞–∑–º—É—Ç —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω"
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º—É—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        return False, f"–û—à–∏–±–∫–∞: {str(e)}"


async def ban_user_in_chat(chat_id, user_id, duration_minutes=1440, reason=""):
    """–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –±–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç–µ"""
    try:
        chat_type = await check_chat_type(chat_id)
        
        if chat_type in ["supergroup", "channel"]:
            until_date = datetime.now() + timedelta(minutes=duration_minutes)
            await bot.edit_permissions(
                chat_id,
                user_id,
                until_date=until_date,
                view_messages=False
            )
        elif chat_type == "group":
            try:
                # –í –æ–±—ã—á–Ω—ã—Ö –≥—Ä—É–ø–ø–∞—Ö –∫–∏–∫–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await bot.kick_participant(chat_id, user_id)
            except:
                return False, "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±–∞–Ω–∏—Ç—å –≤ –æ–±—ã—á–Ω–æ–π –≥—Ä—É–ø–ø–µ"
        else:
            return False, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —á–∞—Ç–∞"
        
        return True, "–ë–∞–Ω —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω"
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–∞–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        return False, f"–û—à–∏–±–∫–∞: {str(e)}"


async def unban_user_in_chat(chat_id, user_id):
    """–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–∞–∑–±–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç–µ"""
    try:
        chat_type = await check_chat_type(chat_id)
        
        if chat_type in ["supergroup", "channel"]:
            await bot.edit_permissions(
                chat_id,
                user_id,
                view_messages=True
            )
        elif chat_type == "group":
            # –í –æ–±—ã—á–Ω—ã—Ö –≥—Ä—É–ø–ø–∞—Ö –ø—Ä–∏–≥–ª–∞—à–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
            try:
                await bot.edit_permissions(
                    chat_id,
                    user_id,
                    until_date=0,
                    view_messages=True
                )
            except:
                return False, "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–±–∞–Ω–∏—Ç—å –≤ –æ–±—ã—á–Ω–æ–π –≥—Ä—É–ø–ø–µ"
        else:
            return False, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —á–∞—Ç–∞"
        
        return True, "–†–∞–∑–±–∞–Ω —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω"
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–∞–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        return False, f"–û—à–∏–±–∫–∞: {str(e)}"


async def send_log(action, admin, user, duration=None, chat=None, reason=None, message_link=None):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ª–æ–≥–∏ –≤ –∫–∞–Ω–∞–ª"""
    text = (
        f"**{action.upper()}**\n\n"
        f"üë§ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** {user.first_name} (`{user.id}`)\n"
        f"üëÆ **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:** {admin.first_name} (`{admin.id}`)\n"
    )
    
    if chat:
        text += f"üí¨ **–ß–∞—Ç:** {chat.title if hasattr(chat, 'title') else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} (`{chat.id}`)\n"
    if duration:
        text += f"‚è≥ **–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** {duration}\n"
    if reason:
        text += f"üìù **–ü—Ä–∏—á–∏–Ω–∞:** {reason}\n"
    if message_link:
        text += f"üîó **–°–æ–æ–±—â–µ–Ω–∏–µ:** [—Å—Å—ã–ª–∫–∞]({message_link})"
    
    try:
        await bot.send_message(LOG_CHANNEL, text, link_preview=False)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∞: {e}")


# ========== –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´ ==========

@bot.on(events.NewMessage(pattern='/start'))
async def start(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    sender = await event.get_sender()
    START_USERS.add(event.sender_id)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if not db.user_exists(sender.id):
        db.add_user(sender.id, sender.username)
    
    inline_buttons = [
        [Button.inline("üñåÔ∏è | –ö–∞—Å—Ç–æ–º –∫–∞—Ä—Ç–∏–Ω–∫–∏", "custom_pics"),
         Button.inline("üëã | –î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É", "add_group")],
        [Button.inline("üî• | –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å–∫–∞–º–µ—Ä–∞", "report_scammer")],
        [Button.inline("ü§ó | –°–æ–∑–¥–∞—Ç–µ–ª—å", "creator")],
        [Button.inline("üíù –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å", "support_handler")],
        [Button.inline("‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ", "about_project")]
    ]
    
    welcome_text = (
        "–ú—ã - WARD ANTISCAM –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ê–Ω—Ç–∏–°–∫–∞–º –±–∞–∑–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è[‚†Ä](https://i.ibb.co/wZ61gwPk/IMG-20251216-230901-226.jpg)!\n"
        f"ü§ì –ü—Ä–æ–≤–µ—Ä–∏–º —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞ —Å–∫–∞–º\n"
        "ü§† –ù–∞–π–¥—ë–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –≥–∞—Ä–∞–Ω—Ç–∞\n"
        "ü§ï –ü–æ–º–æ–∂–µ–º —Å–ª–∏—Ç—å —Å–∫–∞–º–º–µ—Ä–∞\n\n"
        "‚ÑπÔ∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ —Å –±–æ—Ç–æ–º"
    )
    
    await send_response(event, welcome_text, buttons=inline_buttons, link_preview=True)
    
    await send_response(
        event,
        """üçÄ | üéÆ –ú–µ–Ω—é –±–æ—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.

üåø | –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ü—Ä–æ–ø–∏—à–∏—Ç–µ:
<pre>—á–µ–∫ @XOMTG</pre>""",
        buttons=main_buttons,
        parse_mode='html'
    )


@bot.on(events.NewMessage(pattern=r'(?i)^(—á–µ–∫|—á–µ–∫ –º–∏|—á–µ–∫ —è|—á–µ–∫ —Å–µ–±—è|check|/check)'))
async def check_user(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    global checks_count
    user_id = event.sender_id
    user = await event.get_sender()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—É–ª–¥–∞—É–Ω–∞
    current_time = time.time()
    if user_id in last_check_time:
        elapsed_time = current_time - last_check_time[user_id]
        if elapsed_time < 5:
            remaining_time = 5 - elapsed_time
            return await send_response(
                event,
                f"üíÑ –ë—Ä–∞—Ç–∞–Ω—ã —Ç–µ—Ä–ø–µ–ª–∏, –∏ —Ç—ã –ø–æ—Ç–µ—Ä–ø–∏ {remaining_time:.1f} —Å–µ–∫—É–Ω–¥(—ã)!"
            )
    
    last_check_time[user_id] = current_time
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    user_to_check = None
    if event.reply_to_msg_id:
        replied = await event.get_reply_message()
        user_to_check = await event.client.get_entity(replied.sender_id)
    else:
        if "—á–µ–∫ —Å–µ–±—è" in event.raw_text.lower() or "—á–µ–∫ –º–∏" in event.raw_text.lower():
            user_to_check = user
        else:
            args = event.raw_text.split()[1:]
            if args:
                try:
                    if args[0].isdigit():
                        user_to_check = await event.client.get_entity(int(args[0]))
                    elif args[0].startswith('@'):
                        user_to_check = await event.client.get_entity(args[0])
                except:
                    return await send_response(event, "‚ùå | –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
    
    if not user_to_check:
        return await send_response(event, "‚ùå | –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if not db.user_exists(user_to_check.id):
        db.add_user(user_to_check.id, user_to_check.username)
    
    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏
    db.increment_check_count(user_to_check.id)
    checks_count += 1
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_data = db.get_user(user_to_check.id)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
    message_text, buttons = await get_user_profile_response(event, user_to_check, user_data)
    await send_response(event, message_text, buttons=buttons, link_preview=True)
    
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–º–∏—É–º-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if db.is_premium_user(user_id):
        try:
            await bot.send_message(
                user_id,
                f'üîç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å [{user.first_name}](tg://user?id={user_id}) –ø—Ä–æ–≤–µ—Ä—è–ª –≤–∞—Å –≤ –±–æ—Ç–µ!',
                buttons=Button.inline("‚Ü©–°–∫—Ä—ã—Ç—å", b"hide_message")
            )
        except:
            pass


@bot.on(events.NewMessage(pattern=r'(?i)^/—Å–∫–∞–º|/sc|/scam'))
async def scam_command(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∫–∞–º–º–µ—Ä–∞"""
    user_id = event.sender_id
    user_role = db.get_user_role(user_id)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
    allowed_roles = [6, 8, 10, 11, 9]
    if user_role not in allowed_roles and user_id not in OWNER_ID:
        return await send_response(event, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã")
    
    args = event.raw_text.split(maxsplit=2)
    if len(args) < 3:
        return await send_response(event, "‚ùå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /—Å–∫–∞–º @username/ID *–ø—Ä–∏—á–∏–Ω–∞*")
    
    target = args[1]
    reason = args[2].strip('*')
    
    try:
        if target.isdigit():
            user = await event.client.get_entity(int(target))
        else:
            if target.startswith('@'):
                target = target[1:]
            user = await event.client.get_entity(target)
    except:
        return await send_response(event, "‚ùå –ù–µ –º–æ–≥—É –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    target_user_role = db.get_user_role(user.id)
    if target_user_role == 10:
        return await send_response(event, "‚ùå –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ –¥–æ–ø—É—Å—Ç–∏–º–æ, –≤—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∑–∞–Ω–µ—Å—Ç–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –±–∞–∑—ã!")
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID
    unique_id = str(uuid.uuid4())
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if not db.user_exists(user.id):
        db.add_user(user.id, user.username)
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å–∫–∞–º–º–µ—Ä–∞
    db.add_scammer(user.id, reason, str(user_id), reason, unique_id)
    
    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏
    buttons = [
        [Button.inline("–°–∫–∞–º–µ—Ä ‚ùå", f"mark_scammer_{user.id}_{unique_id}")],
        [Button.inline("–í–æ–∑–º–æ–∂–Ω–æ —Å–∫–∞–º–º–µ—Ä ‚ö†Ô∏è", f"mark_possible_{user.id}_{unique_id}")],
        [Button.inline("–ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ –Ω–∞ —Å–∫–∞–º ‚ö†Ô∏è", f"mark_suspect_{user.id}_{unique_id}")],
        [Button.inline("–ü–µ—Ç—É—Ö üêì", f"mark_rooster_{user.id}_{unique_id}")]
    ]
    
    await send_response(
        event,
        f"‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.first_name} | üÜî {user.id}\n\n",
        buttons=buttons
    )


@bot.on(events.NewMessage(pattern=r'/—Ç—Ä–∞—Å—Ç|!trust'))
async def trust_command(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–¥–∞—á–∏ —Ç—Ä–∞—Å—Ç–∞"""
    sender = await event.get_sender()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏
    if db.get_user_role(sender.id) not in [1, 10]:
        return await send_response(
            event,
            "**‚ö†Ô∏è –û—Ç–∫–∞–∑–∞–Ω–æ –≤ –¥–æ—Å—Ç—É–ø–µ!**\n\n"
            f"**üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** [{sender.first_name}](tg://user/{sender.id})\n"
            "**üìõ –ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤\n"
            "**‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:** –í—ã–¥–∞–≤–∞—Ç—å —Ç—Ä–∞—Å—Ç –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –≥–∞—Ä–∞–Ω—Ç—ã –∏ —Å–æ–∑–¥–∞—Ç–µ–ª—å",
            link_preview=True
        )
    
    # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if event.is_reply:
        replied = await event.get_reply_message()
        target = await event.client.get_entity(replied.sender_id)
    else:
        args = event.raw_text.split()
        if len(args) < 2:
            return await send_response(
                event,
                "**‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**\n‚Ä¢ `/trust` (–æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)\n‚Ä¢ `/trust @username`\n‚Ä¢ `/trust ID`"
            )
        try:
            target = await event.client.get_entity(args[1])
        except:
            return await send_response(event, "**‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ü–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º
    target_role = db.get_user_role(target.id)
    if target_role in [6, 7, 8, 9, 10, 11, 12]:
        return await send_response(
            event,
            f"**‚ùå –û—à–∏–±–∫–∞!**\n\n"
            f"**üìõ –ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ª—å–∑—è –≤—ã–¥–∞–≤–∞—Ç—å —Ç—Ä–∞—Å—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—É.\n"
            f"**üìù –¢–µ–∫—É—â–∞—è —Ä–æ–ª—å:** {ROLES[target_role]['name']}"
        )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if not db.user_exists(target.id):
        db.add_user(target.id, target.username)
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–æ–ª—å "–ü—Ä–æ–≤–µ—Ä–µ–Ω –≥–∞—Ä–∞–Ω—Ç–æ–º"
    db.update_role(target.id, 12, granted_by_id=sender.id)
    db.add_grant(target.id, sender.id)
    
    await send_response(
        event,
        f"**‚úÖ –¢—Ä–∞—Å—Ç —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω!**\n\n"
        f"**üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å:** [{target.first_name}](tg://user/{target.id})\n"
        f"**üëÆ –í—ã–¥–∞–ª:** [{sender.first_name}](tg://user/{sender.id})\n"
        f"üíô –†–µ–ø—É—Ç–∞—Ü–∏—è: –ü—Ä–æ–≤–µ—Ä–µ–Ω(–∞) –≥–∞—Ä–∞–Ω—Ç–æ–º ‚úÖ"
    )


@bot.on(events.NewMessage(pattern=r'/untrust|/–∞–Ω—Ç—Ä–∞—Å—Ç|-–∞–Ω—Ç—Ä–∞—Å—Ç'))
async def untrust_command(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–Ω—è—Ç–∏—è —Ç—Ä–∞—Å—Ç–∞"""
    sender = await event.get_sender()
    sender_role = db.get_user_role(sender.id)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
    if sender_role != 1 and sender.id not in OWNER_ID and sender_role not in [10, 11]:
        return await send_response(
            event,
            "**‚ö†Ô∏è –û—Ç–∫–∞–∑–∞–Ω–æ!**\n\n"
            f"**üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** [{sender.first_name}](tg://user/{sender.id})\n"
            "**üìõ –ü—Ä–∏—á–∏–Ω–∞:** –£ —Ç–µ–±—è –ø—Ä–∞–≤ –Ω–µ—Ç—É\n"
            "**‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:** –°–Ω–∏–º–∞—Ç—å —Ç—Ä–∞—Å—Ç –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –≥–∞—Ä–∞–Ω—Ç—ã, —Å–æ–∑–¥–∞—Ç–µ–ª—å –∏ –≤–ª–∞–¥–µ–ª—å—Ü—ã",
            link_preview=True
        )
    
    # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if event.is_reply:
        replied = await event.get_reply_message()
        target = await event.client.get_entity(replied.sender_id)
    else:
        args = event.raw_text.split()
        if len(args) < 2:
            return await send_response(
                event,
                "**‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**\n‚Ä¢ `/untrust` (–æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)\n‚Ä¢ `/untrust @username`\n‚Ä¢ `/untrust ID`"
            )
        try:
            target = await event.client.get_entity(args[1])
        except:
            return await send_response(event, "**‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç—Ä–∞—Å—Ç
    if db.get_user_role(target.id) != 12:
        return await send_response(event, "**‚ùå –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç —Ç—Ä–∞—Å—Ç–∞**")
    
    # –°–Ω–∏–º–∞–µ–º —Ç—Ä–∞—Å—Ç
    db.update_role(target.id, 0)
    
    await send_response(
        event,
        "**‚úÖ –¢—Ä–∞—Å—Ç —É—Å–ø–µ—à–Ω–æ —Å–Ω—è—Ç!**\n\n"
        f"**üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** [{target.first_name}](tg://user/{target.id})\n"
        f"**üëÆ –°–Ω—è–ª:** [{sender.first_name}](tg://user/{sender.id})"
    )


@bot.on(events.NewMessage(pattern=r'(?i)^(–≤—ã–≥–æ–≤–æ—Ä|/–≤—ã–≥–æ–≤–æ—Ä)'))
async def warning_handler(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–¥–∞—á–∏ –≤—ã–≥–æ–≤–æ—Ä–æ–≤"""
    if not event.is_reply:
        return await send_response(event, "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
    
    replied = await event.get_reply_message()
    target_user = await event.client.get_entity(replied.sender_id)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
    user_role = db.get_user_role(event.sender_id)
    if user_role not in [7, 8, 9, 10]:
        return await send_response(event, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–¥–∞—á–∏ –≤—ã–≥–æ–≤–æ—Ä–∞.")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü –ª–∏
    target_user_role = db.get_user_role(target_user.id)
    if target_user_role == 10:
        return await send_response(event, "‚ùå –ù–µ–ª—å–∑—è –≤—ã–¥–∞–≤–∞—Ç—å –≤—ã–≥–æ–≤–æ—Ä—ã –≤–ª–∞–¥–µ–ª—å—Ü—É!")
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if not db.user_exists(target_user.id):
        db.add_user(target_user.id, target_user.username)
    
    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–≥–æ–≤–æ—Ä–æ–≤
    db.update_warnings(target_user.id)
    warnings_count = db.get_warnings_count(target_user.id)
    
    if warnings_count >= 3:
        # –°–Ω–∏–º–∞–µ–º —Å—Ç–∞—Ç—É—Å
        db.update_role(target_user.id, 0)
        db.reset_warnings(target_user.id)
        await send_response(
            event,
            f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å [{target_user.first_name}](tg://user/{target_user.id}) "
            f"–ø–æ–ª—É—á–∏–ª 3 –≤—ã–≥–æ–≤–æ—Ä–∞ –∏ —Ç–µ–ø–µ—Ä—å –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å '–ù–µ—Ç –≤ –±–∞–∑–µ'."
        )
    else:
        await send_response(
            event,
            f"‚úÖ –í—ã–≥–æ–≤–æ—Ä –≤—ã–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é [{target_user.first_name}](tg://user/{target_user.id}) "
            f"(–í—Å–µ–≥–æ: {warnings_count}/3)"
        )


@bot.on(events.NewMessage(pattern=r'(?i)^(/-–≤—ã–≥–æ–≤–æ—Ä|—Å–Ω—è—Ç—å –≤—ã–≥–æ–≤–æ—Ä)'))
async def remove_warnings_handler(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–Ω—è—Ç–∏—è –≤—ã–≥–æ–≤–æ—Ä–æ–≤"""
    if not event.is_reply:
        return await send_response(event, "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
    
    replied = await event.get_reply_message()
    target_user = await event.client.get_entity(replied.sender_id)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
    user_role = db.get_user_role(event.sender_id)
    if user_role not in [7, 8, 9, 10]:
        return await send_response(event, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Å–Ω—è—Ç–∏—è –≤—ã–≥–æ–≤–æ—Ä–æ–≤.")
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–≥–æ–≤–æ—Ä–æ–≤
    warnings_count = db.get_warnings_count(target_user.id)
    
    if warnings_count <= 0:
        return await send_response(
            event,
            f"‚ùå –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [{target_user.first_name}](tg://user/{target_user.id}) –Ω–µ—Ç –≤—ã–≥–æ–≤–æ—Ä–æ–≤."
        )
    
    # –£–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–≥–æ–≤–æ—Ä–æ–≤
    db.cursor.execute(
        'UPDATE users SET warnings = warnings - 1 WHERE user_id = ?',
        (target_user.id,)
    )
    db.conn.commit()
    
    await send_response(
        event,
        f"‚úÖ –í—ã–≥–æ–≤–æ—Ä —Å–Ω—è—Ç —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [{target_user.first_name}](tg://user/{target_user.id})."
    )


@bot.on(events.NewMessage(pattern=r'[+-](?:[–ê-–Ø–∞-—è]+)(?:\s+(?:@?\w+|\d+))?'))
async def handle_role_command(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–¥–∞—á–∏ –∏ —Å–Ω—è—Ç–∏—è —Ä–æ–ª–µ–π"""
    user_role = db.get_user_role(event.sender_id)
    is_admin = event.sender_id in OWNER_ID or user_role == 10
    
    if not is_admin:
        return await send_response(
            event,
            "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã",
            buttons=Button.inline("‚Ü©–°–∫—Ä—ã—Ç—å", b"hide_message")
        )
    
    command_parts = event.raw_text.split()
    action = command_parts[0][0]  # + –∏–ª–∏ -
    role = command_parts[0][1:].lower()
    
    # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        if len(command_parts) > 1:
            target = command_parts[1]
            if target.isdigit():
                user = await event.client.get_entity(int(target))
            else:
                if target.startswith('@'):
                    target = target[1:]
                user = await event.client.get_entity(target)
        else:
            if not event.is_reply:
                return await send_response(
                    event,
                    "‚ùå –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ",
                    buttons=Button.inline("‚Ü©–°–∫—Ä—ã—Ç—å", b"hide_message")
                )
            replied = await event.get_reply_message()
            user = await event.client.get_entity(replied.sender_id)
    except:
        return await send_response(
            event,
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!",
            buttons=Button.inline("‚Ü©–°–∫—Ä—ã—Ç—å", b"hide_message")
        )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if not db.user_exists(user.id):
        db.add_user(user.id, user.username)
    
    role_mapping = {
        '—Å—Ç–∞–∂–µ—Ä': 6,
        '–∞–¥–º–∏–Ω': 7,
        '–¥–∏—Ä–µ–∫—Ç–æ—Ä': 8,
        '–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç': 9,
        '–≥–∞—Ä–∞–Ω—Ç': 1,
        '–∫–æ–¥–µ—Ä': 11,
        '—Å–æ–∑–¥–∞—Ç–µ–ª—å': 10,
        '–∞–π–¥–æ—à': 13
    }
    
    current_role = db.get_user_role(user.id)
    
    if action == '+':
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞
        if user_role == 9 and role in ['–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç']:
            return await send_response(
                event,
                "‚ùå –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –≤—ã–¥–∞–≤–∞—Ç—å —Ä–æ–ª—å –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞.",
                buttons=Button.inline("‚Ü©–°–∫—Ä—ã—Ç—å", b"hide_message")
            )
        
        if current_role in [0, 1]:
            db.update_role(user.id, role_mapping[role])
            await send_response(
                event,
                f"‚úÖ –†–æ–ª—å {role} –≤—ã–¥–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é [{user.first_name}](tg://user?id={user.id})",
                buttons=Button.inline("‚Ü©–°–∫—Ä—ã—Ç—å", b"hide_message")
            )
        else:
            await send_response(
                event,
                "‚ùå –ù–µ–ª—å–∑—è –≤—ã–¥–∞–≤–∞—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –∏–º–µ–µ—Ç —Ä–æ–ª—å.",
                buttons=Button.inline("‚Ü©–°–∫—Ä—ã—Ç—å", b"hide_message")
            )
    else:
        if current_role > 0:
            db.update_role(user.id, 0)
            await send_response(
                event,
                f"‚úÖ –†–æ–ª—å —Å–Ω—è—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [{user.first_name}](tg://user?id={user.id})",
                buttons=Button.inline("‚Ü©–°–∫—Ä—ã—Ç—å", b"hide_message")
            )
        else:
            await send_response(
                event,
                "‚ùå –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç —Ä–æ–ª–∏",
                buttons=Button.inline("‚Ü©–°–∫—Ä—ã—Ç—å", b"hide_message")
            )


@bot.on(events.NewMessage(pattern="üé≠ –ü—Ä–æ—Ñ–∏–ª—å"))
async def my_profile(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è"""
    if not event.is_private:
        try:
            await event.delete()
        except:
            pass
        return
    
    user = await event.get_sender()
    user_id = user.id
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if not db.user_exists(user_id):
        db.add_user(user_id, user.username)
    
    user_data = db.get_user(user_id)
    role_id = user_data['role_id'] if user_data else 0
    role_info = ROLES[role_id]
    
    checks_count = db.get_check_count(user_id)
    scammers_slept = 0
    
    # –î–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–∏—Ç—ã—Ö —Å–∫–∞–º–º–µ—Ä–æ–≤
    if role_id in [6, 7, 8, 9, 10]:
        scammers_slept = db.get_user_scammers_slept(user_id)
    
    # –°—Ç–∞—Ç—É—Å –ø—Ä–µ–º–∏—É–º–∞
    premium_status = "‚úÖ" if db.is_premium_user(user_id) else "‚ùå"
    
    profile_text = f"""
üë§ **–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ:** [{user.first_name}](tg://user/{user_id})

üîç **–í–∞—Å –ø—Ä–æ–≤–µ—Ä—è–ª–∏:** `{checks_count}` —Ä–∞–∑
üî• **–°–∫–∞–º–º–µ—Ä–æ–≤ —Å–ª–∏—Ç–æ:** `{scammers_slept}`
üìù **–†–æ–ª—å –≤ –±–∞–∑–µ:** {role_info['name']}
üëë **WARD –ü—Ä–µ–º–∏—É–º:** {premium_status}
[‚†Ä](https://i.ibb.co/QF3TxtWG/temp-5173733679-1333.jpg)
"""
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    custom_photo = db.get_user_custom_photo(user_id)
    custom_button_text = "üéÜ –°–Ω—è—Ç—å –∫–∞—Å—Ç–æ–º–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" if custom_photo else "üéÜ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–∫—É"
    custom_callback_data = "remove_custom" if custom_photo else "custom_soon"
    
    buttons = [
        [Button.inline("üîé –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–±—è", "check_soon"),
         Button.inline("üé® –¢–µ–º–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏", "themes_soon")],
        [Button.inline("üì¢ –ö–∞–Ω–∞–ª", "channel_soon"),
         Button.inline("üåç –°—Ç—Ä–∞–Ω–∞", "country_soon")],
        [Button.inline(custom_button_text, custom_callback_data)]
    ]
    
    await send_response(event, profile_text, buttons=buttons, link_preview=True)


@bot.on(events.NewMessage(pattern="‚úÖ –ì–∞—Ä–∞–Ω—Ç—ã –±–∞–∑—ã"))
async def list_garants(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å–ø–∏—Å–∫–∞ –≥–∞—Ä–∞–Ω—Ç–æ–≤"""
    if not event.is_private:
        return
    
    loading_message = await send_response(event, "üîÑ –ü–æ–∏—Å–∫ –≥–∞—Ä–∞–Ω—Ç–æ–≤...")
    
    # –ü–æ–ª—É—á–∞–µ–º –≥–∞—Ä–∞–Ω—Ç–æ–≤
    guarantors = db.get_guarantors()
    
    if not guarantors:
        await loading_message.edit("–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≥–∞—Ä–∞–Ω—Ç–æ–≤ –Ω–µ—Ç ‚õî")
        return
    
    text = f"""üí¢ –ê–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≥–∞—Ä–∞–Ω—Ç–æ–≤ WARD ANTISCAM
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ –í—Å–µ–≥–æ: {len(guarantors)}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí° –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Å—Ç–∞—Ç—å –≥–∞—Ä–∞–Ω—Ç–æ–º, –ø—Ä–æ–π–¥–∏—Ç–µ –Ω–∞–±–æ—Ä!
[‚†Ä](https://i.ibb.co/XrQN5hzc/temp-5173733679-1331.jpg)"""
    
    buttons = []
    for uid in guarantors[:20]:  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–æ–ø–æ–∫
        try:
            user = await bot.get_entity(uid)
            buttons.append([Button.inline(f"üõ°Ô∏è {user.first_name}", f"check_{uid}")])
        except:
            continue
    
    await loading_message.delete()
    await send_response(event, text, buttons=buttons, link_preview=True)


@bot.on(events.NewMessage(pattern="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑—ã"))
async def statistics(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
    if not event.is_private:
        return
    
    loading_message = await send_response(event, "üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...")
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    stats = db.get_statistics()
    
    text = f"""üîç –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ WARD ANTISCAM:
[‚†Ä](https://i.ibb.co/Fzpqd0K/IMG-3735.jpg)

üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats['total_users']}
üíé –ì–∞—Ä–∞–Ω—Ç–æ–≤: {stats['guarantors']}
üë®‚Äçüéì –°—Ç–∞–∂–µ—Ä–æ–≤: {stats['trainees']}
üö´ –°–∫–∞–º–º–µ—Ä–æ–≤: {stats['scammers']}

üì© –°–æ–æ–±—â–µ–Ω–∏–π: {stats['total_messages']}
üîÑ –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {stats['last_update'][:19] if stats['last_update'] else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
"""
    
    buttons = [
        [Button.inline("üèÜ –¢–æ–ø –°—Ç–∞–∂–µ—Ä–æ–≤", b"top_trainees")],
        [Button.inline("üòé –¢–æ–ø –ê–∫—Ç–∏–≤–Ω—ã—Ö", b"top_day")]
    ]
    
    await loading_message.delete()
    await send_response(event, text, buttons=buttons, link_preview=True)


@bot.on(events.NewMessage(pattern="üö´ –°–ª–∏—Ç—å —Å–∫–∞–º–º–µ—Ä–∞!"))
async def report_scammer(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å–ª–∏–≤–∞ —Å–∫–∞–º–º–µ—Ä–∞"""
    if not event.is_private:
        return
    
    keyboard = types.KeyboardButtonUrl(
        text="üö® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É", 
        url="https://t.me/WARDREPORT"
    )
    
    text = """üî• –í—ã —Ö–æ—Ç–∏—Ç–µ —Å–ª–∏—Ç—å —Å–∫–∞–º–º–µ—Ä–∞? üî•

‚ö°Ô∏è –õ—É—á—à–µ–µ —Ä–µ—à–µ–Ω–∏–µ:
‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "üö® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É"
‚Ä¢ –ù–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª –ø—Ä–∏–º–µ—Ç –º–µ—Ä—ã –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–∫–æ—Ç–æ—Ä–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, –ø—Ä–æ—Å—Ç–æ —Å–∫–∏–Ω—å—Ç–µ –ø—Ä—É—Ñ—ã!

üîí –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å —Å–∫–∞–º–∞?:
1. ‚úÖ –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ /check
2. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –≥–∞—Ä–∞–Ω—Ç–æ–≤
3. ‚úÖ –¢—Ä–µ–±—É–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã
4. ‚úÖ –ü—Ä–∏ –º–∞–ª–µ–π—à–∏—Ö —Å–æ–º–Ω–µ–Ω–∏—è—Ö - –æ—Ç–º–µ–Ω—è–π—Ç–µ —Å–¥–µ–ª–∫—É

üìõ –ü–æ–º–Ω–∏—Ç–µ: 95% —Å–∫–∞–º–∞ –º–æ–∂–Ω–æ –∏–∑–±–µ–∂–∞—Ç—å, —Å–ª–µ–¥—É—è —ç—Ç–∏–º –ø—Ä–∞–≤–∏–ª–∞–º!
[‚†Ä](https://i.ibb.co/Z11xspsh/temp-5173733679-1329.jpg)"""
    
    await send_response(event, text, buttons=keyboard, link_preview=True)


@bot.on(events.NewMessage(pattern="üë®‚Äçüéì –í–æ–ª–æ–Ω—Ç—ë—Ä—ã –±–∞–∑—ã"))
async def list_volunteers(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å–ø–∏—Å–∫–∞ –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤"""
    if not event.is_private:
        return
    
    loading_message = await send_response(event, "üîÑ –ü–æ–∏—Å–∫ –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤...")
    
    # –ü–æ–ª—É—á–∞–µ–º –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤ (—Ä–æ–ª–∏ 6-10)
    volunteers = []
    for role_id in [6, 7, 8, 9, 10]:
        db.cursor.execute('SELECT user_id FROM users WHERE role_id = ?', (role_id,))
        volunteers.extend([row[0] for row in db.cursor.fetchall()])
    
    if not volunteers:
        await loading_message.edit("–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤–æ–ª–æ–Ω—Ç—ë—Ä–æ–≤ –Ω–µ—Ç ‚õî")
        return
    
    text = f"""ü§ù –ê–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤–æ–ª–æ–Ω—Ç—ë—Ä–æ–≤ WARD ANTISCAM
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ –í—Å–µ–≥–æ: {len(volunteers)}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí° –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å—Ç–∞—Ç—å –≤–æ–ª–æ–Ω—Ç—ë—Ä–æ–º –±–∞–∑—ã, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–π–¥–∏—Ç–µ –Ω–∞–±–æ—Ä!
[‚†Ä](https://i.ibb.co/MYm2Qwz/temp-5173733679-1330.jpg)"""
    
    buttons = []
    for uid in volunteers[:20]:
        try:
            user = await bot.get_entity(uid)
            role_id = db.get_user_role(uid)
            role_name = ROLES[role_id]["name"]
            buttons.append([Button.inline(f"{role_name} {user.first_name}", f"check_{uid}")])
        except:
            continue
    
    await loading_message.delete()
    await send_response(event, text, buttons=buttons, link_preview=True)


@bot.on(events.NewMessage(pattern="üî∞ –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"))
async def list_verified_users(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    if not event.is_private:
        return
    
    loading_message = await send_response(event, "üîÑ –ü–æ–∏—Å–∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...")
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    verified_users = db.get_verified_users()
    
    if not verified_users:
        await loading_message.edit("–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç ‚õî")
        return
    
    text = f"""üìä –°–ø–∏—Å–æ–∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π WARD ANTISCAM
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ –í—Å–µ–≥–æ: {len(verified_users)}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
"""
    
    buttons = []
    for uid in verified_users[:20]:
        try:
            user = await bot.get_entity(uid)
            buttons.append([Button.inline(f"‚úÖ {user.first_name}", f"check_{uid}")])
        except:
            continue
    
    await loading_message.delete()
    await send_response(event, text, buttons=buttons, link_preview=True)


@bot.on(events.NewMessage(pattern="üîì –ü—Ä–µ–º–∏—É–º"))
async def premium_info(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø—Ä–µ–º–∏—É–º–∞"""
    if not event.is_private:
        return
    
    loading_message = await send_response(event, "üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–µ–º–∏—É–º–µ...")
    
    text = f"""–û—Ç–∫—Ä–æ–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏: [ ](https://i.ibb.co/wZ61gwPk/IMG-20251216-230901-226.jpg)

‚Ä¢ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ–±–µ –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Ñ–æ—Ç–æ
‚Ä¢ –ü–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å–≤–æ–π –∫–∞–Ω–∞–ª
‚Ä¢ –ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö
–í—Å–µ —ç—Ç–∏ —Ñ–∏—à–∫–∏ –≤—Ö–æ–¥—è—Ç –≤ WARD Premium
"""
    
    buttons = [
        [Button.url("üí∞ –û–ø–ª–∞—Ç–∞", "https://t.me/XOMTG")],
        [Button.inline("‚Ü© –°–∫—Ä—ã—Ç—å", b"hide_message")]
    ]
    
    await loading_message.delete()
    await send_response(event, text, buttons=buttons, link_preview=True)


@bot.on(events.NewMessage(pattern=r'(?i)^\+—Å–ø–∞—Å–∏–±–æ'))
async def thank_command(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã +—Å–ø–∞—Å–∏–±–æ"""
    user_id = event.sender_id
    user_role = db.get_user_role(user_id)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
    allowed_roles = [6, 8, 10, 11, 9]
    if user_role not in allowed_roles:
        return
    
    # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if event.reply_to_msg_id:
        reply_message = await event.get_reply_message()
        target_user_id = reply_message.sender_id
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        target_user_role = db.get_user_role(target_user_id)
        if target_user_role in [1, 6, 8, 9, 10, 11]:
            return
    else:
        return
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if not db.user_exists(target_user_id):
        db.add_user(target_user_id, None)
    
    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–∫–∞–º–º–µ—Ä–æ–≤
    db.increment_scammers_count(target_user_id)
    
    await send_response(
        event,
        f"üìõ –•–æ—Ä–æ—à–æ!, –≤—ã —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–ª–∏ +1 —Å–ª–∏—Ç–æ–≥–æ —Å–∫–∞–º–º–µ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å ID {target_user_id}.\n\n"
        "üìà –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –±–æ—Ä–µ—Ç–µ—Å—å —Å–æ —Å–∫–∞–º–æ–º –≤–º–µ—Å—Ç–µ —Å WARD ANTISCAM.\n\n"
        "‚òï –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –µ—â—ë —Å–∫–∞–º–º–µ—Ä—ã, —Å–æ–æ–±—â–∏—Ç–µ –æ–± —ç—Ç–æ–º –Ω–∞—à–∏–º —Å—Ç–∞–∂—ë—Ä–∞–º –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º, "
        "–∏ –æ–Ω–∏ –∑–∞–Ω–µ—Å—É—Ç —Å–∫–∞–º–º–µ—Ä–∞ –≤ –±–∞–∑—É!"
    )


@bot.on(events.NewMessage(pattern=r'(?i)^/on$'))
async def enable_chat(event):
    """–í–∫–ª—é—á–µ–Ω–∏–µ —á–∞—Ç–∞"""
    user_id = event.sender_id
    if db.get_user_role(user_id) != 10:
        return await send_response(event, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
    
    try:
        await bot.edit_permissions(event.chat_id, send_messages=True)
        await send_response(
            event,
            "üîì –ß–∞—Ç –æ—Ç–∫—Ä—ã—Ç, –≤—ã —Å–Ω–æ–≤–∞ –º–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç!"
            "[‚†Ä](https://i.ibb.co/JFq2r3Dg/image.jpg)",
            link_preview=True
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è —á–∞—Ç–∞: {e}")


@bot.on(events.NewMessage(pattern=r'(?i)^/off$'))
async def disable_chat(event):
    """–û—Ç–∫–ª—é—á–µ–Ω–∏–µ —á–∞—Ç–∞"""
    user_id = event.sender_id
    if db.get_user_role(user_id) != 10:
        return await send_response(event, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
    
    try:
        await bot.edit_permissions(event.chat_id, send_messages=False)
        await send_response(
            event,
            "üîí –ß–∞—Ç –∑–∞–∫—Ä—ã—Ç –Ω–∞ –≤—Ä–µ–º—è, —Å–∫–æ—Ä–æ –º—ã –≤–µ—Ä–Ω—ë–º—Å—è –≤ —Å—Ç—Ä–æ–π, —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–æ–≤–æ—Å—Ç—è–º–∏!"
            "[‚†Ä](https://i.ibb.co/JFq2r3Dg/image.jpg)",
            link_preview=True
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è —á–∞—Ç–∞: {e}")


@bot.on(events.NewMessage(pattern=r'(?i)^–∞–¥–º–∏–Ω—ã!$'))
async def call_admins(event):
    """–í—ã–∑–æ–≤ –∞–¥–º–∏–Ω–æ–≤"""
    user_id = event.sender_id
    current_time = datetime.now()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—É–ª–¥–∞—É–Ω–∞
    if user_id in admin_cooldowns:
        time_diff = current_time - admin_cooldowns[user_id]
        if time_diff < timedelta(hours=4):
            remaining = timedelta(hours=4) - time_diff
            hours = remaining.seconds // 3600
            minutes = (remaining.seconds % 3600) // 60
            return await send_response(
                event,
                f"**‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ {hours} —á. {minutes} –º–∏–Ω. –ø—Ä–µ–∂–¥–µ —á–µ–º —Å–Ω–æ–≤–∞ –≤—ã–∑—ã–≤–∞—Ç—å –∞–¥–º–∏–Ω–æ–≤!**"
            )
    
    admin_cooldowns[user_id] = current_time
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–¥–º–∏–Ω–æ–≤ –∏–∑ –ë–î
    admins = []
    for role_id in [6, 7, 8, 9, 10]:
        db.cursor.execute('SELECT user_id FROM users WHERE role_id = ?', (role_id,))
        admins.extend([row[0] for row in db.cursor.fetchall()])
    
    mentions_text = "**‚úÖ –ê–¥–º–∏–Ω—ã –≤—ã–∑–≤–∞–Ω—ã!**"
    for admin_id in admins:
        mentions_text += f"[\u200b](tg://user?id={admin_id})"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º
        try:
            caller = await event.get_sender()
            caller_mention = f"@{caller.username}" if caller.username else caller.mention
            await bot.send_message(
                admin_id,
                f"**üö® –í —á–∞—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {caller_mention} –≤—ã–∑—ã–≤–∞–µ—Ç –∞–¥–º–∏–Ω–æ–≤!**"
            )
        except:
            pass
    
    await send_response(event, mentions_text)


@bot.on(events.NewMessage(pattern=r'(?i)^–≥–∞—Ä–∞–Ω—Ç—ã!$'))
async def call_guarantors(event):
    """–í—ã–∑–æ–≤ –≥–∞—Ä–∞–Ω—Ç–æ–≤"""
    user_id = event.sender_id
    current_time = datetime.now()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—É–ª–¥–∞—É–Ω–∞
    if user_id in guarantor_cooldowns:
        time_diff = current_time - guarantor_cooldowns[user_id]
        if time_diff < timedelta(hours=1):
            remaining = timedelta(hours=1) - time_diff
            hours = remaining.seconds // 3600
            minutes = (remaining.seconds % 3600) // 60
            return await send_response(
                event,
                f"**‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ {hours} —á. {minutes} –º–∏–Ω. –ø—Ä–µ–∂–¥–µ —á–µ–º —Å–Ω–æ–≤–∞ –≤—ã–∑—ã–≤–∞—Ç—å –≥–∞—Ä–∞–Ω—Ç–æ–≤!**"
            )
    
    guarantor_cooldowns[user_id] = current_time
    
    # –ü–æ–ª—É—á–∞–µ–º –≥–∞—Ä–∞–Ω—Ç–æ–≤
    guarantors = db.get_guarantors()
    
    mentions_text = "**üî∞ –ì–∞—Ä–∞–Ω—Ç—ã –≤—ã–∑–≤–∞–Ω—ã!**"
    for guarantor_id in guarantors:
        mentions_text += f"[\u200b](tg://user?id={guarantor_id})"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≥–∞—Ä–∞–Ω—Ç–∞–º
        try:
            caller = await event.get_sender()
            caller_mention = f"@{caller.username}" if caller.username else caller.mention
            await bot.send_message(
                guarantor_id,
                f"**üö® –í —á–∞—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {caller_mention} –≤—ã–∑—ã–≤–∞–µ—Ç –≥–∞—Ä–∞–Ω—Ç–æ–≤!**"
            )
        except:
            pass
    
    await send_response(event, mentions_text)


@bot.on(events.NewMessage(pattern=r'/–ø—Ä–æ—Ñ–∏–ª—å'))
async def profile_command(event):
    """–ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ—Ñ–∏–ª—è"""
    user = await event.get_sender()
    user_id = user.id
    
    if not db.user_exists(user_id):
        db.add_user(user_id, user.username)
    
    role_id = db.get_user_role(user_id)
    role_info = ROLES[role_id]
    checks_count = db.get_check_count(user_id)
    
    scammers_slept = 0
    if role_id in [6, 7, 8, 9, 10]:
        scammers_slept = db.get_user_scammers_slept(user_id)
    
    premium_expiry = db.get_premium_expiry(user_id)
    is_premium = premium_expiry is not None and datetime.strptime(premium_expiry, "%Y-%m-%d %H:%M:%S") > datetime.now()
    premium_status = "‚úÖ" if is_premium else "‚ùå"
    
    profile_text = f"""
**üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:** [{user.first_name}](tg://user/{user_id})

üîç **–í–∞—Å –ø—Ä–æ–≤–µ—Ä—è–ª–∏:** `{checks_count}` —Ä–∞–∑
üî• **–°–∫–∞–º–º–µ—Ä–æ–≤ —Å–ª–∏—Ç–æ:** `{scammers_slept}`
**üìù –†–æ–ª—å –≤ –±–∞–∑–µ:** {role_info['name']}
**WARD –ü—Ä–µ–º–∏—É–º:** {premium_status}
[‚†Ä](https://i.ibb.co/QF3TxtWG/temp-5173733679-1333.jpg)
"""
    
    await send_response(event, profile_text, link_preview=True)


@bot.on(events.NewMessage(pattern=r'/help'))
async def help_cmd(event):
    """–ö–æ–º–∞–Ω–¥–∞ –ø–æ–º–æ—â–∏"""
    help_text = """
ü§ñ **–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ WARD ANTISCAM:**

üìã **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
‚Ä¢ `—á–µ–∫ [—é–∑–µ—Ä–Ω–µ–π–º/ID]` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚Ä¢ `—á–µ–∫` (–æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ) - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚Ä¢ `—á–µ–∫ –º–∏/—è/—Å–µ–±—è` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–±—è

üëÆ‚Äç‚ôÇÔ∏è **–í—ã–¥–∞—á–∞ —Ä–æ–ª–µ–π:**
‚Ä¢ `+—Å—Ç–∞–∂–µ—Ä` (–æ—Ç–≤–µ—Ç–æ–º) - –≤—ã–¥–∞—Ç—å —Ä–æ–ª—å —Å—Ç–∞–∂–µ—Ä–∞  
‚Ä¢ `+–∞–¥–º–∏–Ω` (–æ—Ç–≤–µ—Ç–æ–º) - –≤—ã–¥–∞—Ç—å —Ä–æ–ª—å –∞–¥–º–∏–Ω–∞
‚Ä¢ `+–¥–∏—Ä–µ–∫—Ç–æ—Ä` (–æ—Ç–≤–µ—Ç–æ–º) - –≤—ã–¥–∞—Ç—å —Ä–æ–ª—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞
‚Ä¢ `+–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç` (–æ—Ç–≤–µ—Ç–æ–º) - –≤—ã–¥–∞—Ç—å —Ä–æ–ª—å –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞ 
‚Ä¢ `+—Å–æ–∑–¥–∞—Ç–µ–ª—å` (–æ—Ç–≤–µ—Ç–æ–º) - –≤—ã–¥–∞—Ç—å —Ä–æ–ª—å —Å–æ–∑–¥–∞—Ç–µ–ª—è
‚Ä¢ `+–∫–æ–¥–µ—Ä` (–æ—Ç–≤–µ—Ç–æ–º) - –≤—ã–¥–∞—Ç—å —Ä–æ–ª—å –∫–æ–¥–µ—Ä–∞
‚Ä¢ `+–≥–∞—Ä–∞–Ω—Ç` (–æ—Ç–≤–µ—Ç–æ–º) - –≤—ã–¥–∞—Ç—å —Ä–æ–ª—å –≥–∞—Ä–∞–Ω—Ç–∞

üîÑ **–°–Ω—è—Ç–∏–µ —Ä–æ–ª–µ–π:**
‚Ä¢ `-—Å—Ç–∞–∂–µ—Ä` (–æ—Ç–≤–µ—Ç–æ–º) - —Å–Ω—è—Ç—å —Ä–æ–ª—å —Å—Ç–∞–∂–µ—Ä–∞
‚Ä¢ `-–∞–¥–º–∏–Ω` (–æ—Ç–≤–µ—Ç–æ–º) - —Å–Ω—è—Ç—å —Ä–æ–ª—å –∞–¥–º–∏–Ω–∞  
‚Ä¢ `-–¥–∏—Ä–µ–∫—Ç–æ—Ä` (–æ—Ç–≤–µ—Ç–æ–º) - —Å–Ω—è—Ç—å —Ä–æ–ª—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞
‚Ä¢ `-–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç` (–æ—Ç–≤–µ—Ç–æ–º) - —Å–Ω—è—Ç—å —Ä–æ–ª—å –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞
‚Ä¢ `-—Å–æ–∑–¥–∞—Ç–µ–ª—å` (–æ—Ç–≤–µ—Ç–æ–º) - —Å–Ω—è—Ç—å —Ä–æ–ª—å —Å–æ–∑–¥–∞—Ç–µ–ª—è  
‚Ä¢ `-–∫–æ–¥–µ—Ä` (–æ—Ç–≤–µ—Ç–æ–º) - —Å–Ω—è—Ç—å —Ä–æ–ª—å –∫–æ–¥–µ—Ä–∞
‚Ä¢ `-–≥–∞—Ä–∞–Ω—Ç` (–æ—Ç–≤–µ—Ç–æ–º) - —Å–Ω—è—Ç—å —Ä–æ–ª—å –≥–∞—Ä–∞–Ω—Ç–∞

‚ö†Ô∏è **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:**
–ö–æ–º–∞–Ω–¥—ã –≤—ã–¥–∞—á–∏ –∏ —Å–Ω—è—Ç–∏—è —Ä–æ–ª–µ–π –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—é –∏ –∫–æ–¥–µ—Ä—É!

üéØ **–î—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã:**
‚Ä¢ `/—Ç—Ä–∞—Å—Ç @username` - –≤—ã–¥–∞—Ç—å —Ç—Ä–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
‚Ä¢ `/untrust @username` - —Å–Ω—è—Ç—å —Ç—Ä–∞—Å—Ç
‚Ä¢ `/—Å–∫–∞–º @username –ø—Ä–∏—á–∏–Ω–∞` - –¥–æ–±–∞–≤–∏—Ç—å —Å–∫–∞–º–º–µ—Ä–∞
‚Ä¢ `/unscam @username` - —Å–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å —Å–∫–∞–º–º–µ—Ä–∞
‚Ä¢ `/–ø—Ä–æ—Ñ–∏–ª—å` - –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å
‚Ä¢ `/–≥–∞—Ä–∞–Ω—Ç—ã` - —Å–ø–∏—Å–æ–∫ –æ–Ω–ª–∞–π–Ω –≥–∞—Ä–∞–Ω—Ç–æ–≤
‚Ä¢ `–∞–¥–º–∏–Ω—ã!` - –≤—ã–∑–≤–∞—Ç—å –∞–¥–º–∏–Ω–æ–≤
‚Ä¢ `–≥–∞—Ä–∞–Ω—Ç—ã!` - –≤—ã–∑–≤–∞—Ç—å –≥–∞—Ä–∞–Ω—Ç–æ–≤
"""
    await send_response(event, help_text)


@bot.on(events.NewMessage(pattern=r'/unscam|–∞–Ω—Å–∫–∞–º'))
async def unscam_handler(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–Ω—è—Ç–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–∫–∞–º–µ—Ä–∞"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
    user_role = db.get_user_role(event.sender_id)
    if event.sender_id not in OWNER_ID and user_role not in [6, 8, 10, 11]:
        return await send_response(event, "‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∫–æ–º–∞–Ω–¥—É")
    
    # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if event.is_reply:
        replied = await event.get_reply_message()
        target = await event.client.get_entity(replied.sender_id)
    else:
        args = event.raw_text.split()
        if len(args) < 2:
            return await send_response(event, "‚ùå –ò—Å–ø–æ–ª—å–∑—É–π: /unscam @username –∏–ª–∏ –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ")
        try:
            target = await event.client.get_entity(args[1])
        except:
            return await send_response(event, "‚ùå –ù–µ –º–æ–≥—É –Ω–∞–π—Ç–∏ —á–µ–ª–∞")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
    current_role = db.get_user_role(target.id)
    if current_role not in [2, 3, 4, 5]:
        return await send_response(event, "‚ÑπÔ∏è –£ —á–µ–ª–æ–≤–µ–∫–∞ –Ω–µ—Ç —Å—Ç–∞—Ç—É—Å–∞ —Å–∫–∞–º–º–µ—Ä–∞")
    
    # –°–Ω–∏–º–∞–µ–º —Å—Ç–∞—Ç—É—Å
    db.update_role(target.id, 0)
    db.remove_scammer_status(target.id)
    
    await send_response(
        event,
        f"‚úÖ –°—Ç–∞—Ç—É—Å —Å–∫–∞–º–º–µ—Ä–∞ —Å–Ω—è—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [{target.first_name}](tg://user/{target.id})"
    )


@bot.on(events.NewMessage(pattern=r'(?i)^–ø—Ä–æ–¥–∞—Ç—å (.+)'))
async def sell_command(event):
    """–ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–¥–∞–∂–∏"""
    user_id = event.sender_id
    item_to_sell = event.pattern_match.group(1)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–¥–∞—É–Ω–∞
    current_time = time.time()
    if user_id in last_check_time:
        if current_time - last_check_time[user_id] < 10:
            await send_response(event, "–ü–æ—Ç–µ—Ä–ø–∏ –±—Ä–∞–¥–æ–∫, 10 —Å–µ–∫—É–Ω–¥ –Ω–µ —Ç–∞–∫ —É–∂ –∏ –º–Ω–æ–≥–æ.")
            return
    
    last_check_time[user_id] = current_time
    
    # –®–∞–Ω—Å –Ω–∞ —É—Å–ø–µ—Ö (15%)
    if random.randint(1, 100) <= 15:
        success_texts = [
            f"–Å–Å–Å–Å–Å–Å–£–£–£–£–£–£–£–£–£üòéüòéüòé –î–∞ —Ç—ã —Å–≤–æ–µ–≥–æ {item_to_sell} –ø—Ä–æ–¥–∞–ª —Ü—ã–≥–∞–Ω–∞–º –∑–∞ 5 –∫–æ–ø–µ–µ–∫!",
            f"–ù–∏—Ö—É—è —Å–µ–±–µ –∫–∞–∫–æ–π –≤–∞–∂–Ω—ã–π —Ö—É–π –±—É–º–∞–∂–Ω—ã–πüé¥, —Ç—ã –ø—Ä–æ–¥–∞–ª —Å–≤–æ–µ–≥–æ {item_to_sell} –Ω–∞ –æ—Ä–≥–∞–Ω—ã!",
            f"–û!, –∞ –∫—É–¥–∞ —ç—Ç–æ —Ç–≤–æ–π {item_to_sell} –¥–µ–ª—Å—è? –ö–∞–∂–∏—Å—å –µ–≥–æ —Ü—ã–≥–∞–Ω–∏ —Å–ø–∏–∑–¥–∏–ª–∏!"
        ]
        await send_response(event, random.choice(success_texts))
    else:
        losses = random.randint(1, 10)
        response_texts = [
            f"–ë–õ–Ø–Ø–Ø–Ø–Ø–Ø–Ø–Ø–Ø–Ø–Øüò≠üò≠ –¢—ã –ø—Ä–æ–µ–±–∞–ª —Å–≤–æ–µ–≥–æ {item_to_sell} –≤ –∫–∞–∑–∏–∫, –∫–∞–∂–∏—Å—å –µ–≥–æ –ª–æ–≥–∏ —Å—Ö–∞–≤–∞–ª–∏.\n\n–í—Å–µ–≥–æ —Ç—ã –ø—Ä–æ–µ–±–∞–ª {losses}.",
            f"–ê–•–•–•–ü–ê–•–•–ê–•–ê–•–ê–ü–•–ü–ê–•–ê–ü–• –ï–ë–ê–¢–¨ –¢–´ –õ–û–•ü§£ü§£, –¢—ã –≥–¥–µ-—Ç–æ –ø—Ä–æ–µ–±–∞–ª {item_to_sell}!\n\n–í—Å–µ–≥–æ –ø—Ä–æ—ë–±–∞–Ω–æ {losses}.",
            f"–õ–µ–ª–µ–ª–µ–ª–µ–ª–µ–ª–µüòë, —Ç–µ–±–µ —á—ë –∑–∞–Ω—è—Ç—Å—è –Ω–µ—Ö—É–π? —Å–≤–æ–µ–≥–æ {item_to_sell} –Ω–∞ –±–∞–∑–∞—Ä–µ –ø—Ä–æ–¥–∞–≤–∞—Ç—å.\n\n–í—Å–µ–≥–æ –ø—Ä–æ—ë–±–∞–Ω–æ {losses}."
        ]
        
        response_message = random.choice(response_texts)
        buttons = [
            [Button.inline("üîç–ò—Å–∫–∞—Ç—å –µ—â—ë —Ä–∞–∑!", f"search_again_{user_id}"),
             Button.inline("ü§ë–ì–æ–π–¥–∞ –ø—Ä–æ–¥–∞–¥–∏–º —á—Ç–æ-—Ç–æ?", f"sell_something_{user_id}")]
        ]
        
        await send_response(event, response_message, buttons=buttons)


@bot.on(events.NewMessage(pattern=r'/–¥–æ–±–∞–≤–∏—Ç—å|/add'))
async def add_description_handler(event):
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è"""
    user_role = db.get_user_role(event.sender_id)
    if event.sender_id not in OWNER_ID and user_role not in [6, 8, 10, 11]:
        return await send_response(event, "‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∫–æ–º–∞–Ω–¥—É")
    
    args = event.raw_text.split(maxsplit=2)
    if len(args) < 3:
        return await send_response(event, "‚ùå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /add @username –æ–ø–∏—Å–∞–Ω–∏–µ")
    
    target_username = args[1]
    description = args[2]
    
    try:
        if target_username.startswith('@'):
            target_username = target_username[1:]
        target = await event.client.get_entity(target_username)
    except:
        return await send_response(event, "‚ùå –ù–µ –º–æ–≥—É –Ω–∞–π—Ç–∏ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if not db.user_exists(target.id):
        db.add_user(target.id, target.username)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
    db.update_description(target.id, description)
    
    await send_response(
        event,
        f"‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [{target.first_name}](tg://user/{target.id}) –æ–±–Ω–æ–≤–ª–µ–Ω–æ: {description}"
    )


@bot.on(events.NewMessage(pattern=r'(?i)^/–≥–∞—Ä–∞–Ω—Ç—ã$'))
async def list_online_garants(event):
    """–°–ø–∏—Å–æ–∫ –æ–Ω–ª–∞–π–Ω –≥–∞—Ä–∞–Ω—Ç–æ–≤"""
    await send_response(event, "–ò—â—É –æ–Ω–ª–∞–π–Ω –≥–∞—Ä–∞–Ω—Ç–æ–≤...")
    
    # –ü–æ–ª—É—á–∞–µ–º –≥–∞—Ä–∞–Ω—Ç–æ–≤
    guarantors = db.get_guarantors()
    
    online_garants = []
    for uid in guarantors:
        try:
            user = await bot.get_entity(uid)
            if user.status is None or user.status == "online" or isinstance(user.status, UserStatusRecently):
                online_garants.append(user)
        except:
            continue
    
    if not online_garants:
        return await send_response(event, "–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –æ–Ω–ª–∞–π–Ω –≥–∞—Ä–∞–Ω—Ç–æ–≤ –Ω–µ—Ç ‚õî")
    
    text = "üìä –í–æ—Ç –Ω–∞—à —Å–ø–∏—Å–æ–∫ –æ–Ω–ª–∞–π–Ω –≥–∞—Ä–∞–Ω—Ç–æ–≤:\n"
    buttons = []
    for user in online_garants[:20]:
        buttons.append([Button.inline(f"üõ°Ô∏è {user.first_name}", f"check_{user.id}")])
    
    await send_response(event, text, buttons=buttons, link_preview=True)


@bot.on(events.NewMessage(pattern=r'/–æ—Ñ—Ñ—Ç–æ–ø'))
async def handle_offtopic_command(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ñ—Ñ—Ç–æ–ø–∞"""
    allowed_roles = [1, 6, 7, 8, 9, 10]
    if event.sender_id not in OWNER_ID and db.get_user_role(event.sender_id) not in allowed_roles:
        return await send_response(event, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
    
    if not event.is_group and not event.is_channel:
        return await send_response(event, "‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö –∏ –∫–∞–Ω–∞–ª–∞—Ö.")
    
    if event.is_reply:
        replied = await event.get_reply_message()
        target_user = await event.client.get_entity(replied.sender_id)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
        can_moderate, reason = await can_use_moderation(event.chat_id, event.sender_id)
        if not can_moderate:
            return await send_response(event, f"‚ùå {reason}")
        
        try:
            # –í—ã–¥–∞–µ–º –º—É—Ç –Ω–∞ 30 –º–∏–Ω—É—Ç
            success, message = await mute_user_in_chat(
                event.chat_id,
                target_user.id,
                duration_minutes=30,
                reason="–û—Ñ—Ñ—Ç–æ–ø"
            )
            
            if success:
                mute_message = (
                    f"{target_user.first_name} –≤—ã–¥–∞–Ω –º—É—Ç –Ω–∞ 30 –º–∏–Ω—É—Ç\n\n"
                    f"–ü—Ä–∏—á–∏–Ω–∞: –û—Ñ—Ñ—Ç–æ–ø\n\n"
                    f"–æ–±—â–∞–π—Ç–µ—Å—å –≤ –Ω–∞—à–µ–º —á–∞—Ç–µ –¥–ª—è –æ—Ñ—Ñ—Ç–æ–ø–∞‚òï"
                )
                
                keyboard = [[Button.url("–ü–µ—Ä–µ–π—Ç–∏", "https://t.me/WARDREPORT")]]
                await send_response(event, mute_message, buttons=keyboard)
                await replied.delete()
            else:
                await send_response(event, f"‚ùå {message}")
        except Exception as e:
            await send_response(event, f"‚ùå –ù–µ –º–æ–≥—É –≤—ã–¥–∞—Ç—å –º—É—Ç: {e}")
    else:
        await send_response(event, "‚ùå –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–º—É –Ω—É–∂–Ω–æ –≤—ã–¥–∞—Ç—å –º—É—Ç.")


@bot.on(events.NewMessage(pattern=r'/–º–∞–≥–∞–∑–∏–Ω'))
async def shop_handler(event):
    """–ú–∞–≥–∞–∑–∏–Ω"""
    user_id = event.sender_id
    balance = db.get_premium_points(user_id)
    
    if balance == 0:
        db.add_premium_points(user_id, 1000)
        balance = 1000
    
    buttons = [
        [Button.inline("–ü—Ä–µ–º 1–¥ (10 –∫–æ–∏–Ω–æ–≤)", data="buy_premium_1d")],
        [Button.inline("–ü—Ä–µ–º 1–Ω (50 –∫–æ–∏–Ω–æ–≤)", data="buy_premium_7d")],
        [Button.inline("–ü—Ä–µ–º 1–º (125 –∫–æ–∏–Ω–æ–≤)", data="buy_premium_30d")],
        [Button.inline("–û—Ç–¥—ã—Ö 1–¥ (100 –∫–æ–∏–Ω–æ–≤)", data="buy_rest_1d")],
        [Button.inline(f"–°—É–º–º–∞: {balance} –æ—á–∫–æ–≤")]
    ]
    
    await send_response(event, "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω WARD ANTISCAM!", buttons=buttons)


@bot.on(events.NewMessage(pattern=r'(?i)^(/|\.)?(mute|–º—É—Ç)(@\w+)?\s*(\d+[–¥–º—áh])\s*(.*)'))
async def mute_handler(event):
    """–ú—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    username = event.pattern_match.group(3)
    replied = await event.get_reply_message() if not username else None
    
    if username:
        try:
            user = await bot.get_entity(username)
        except:
            return await send_response(event, "‚ö†Ô∏è **–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**")
    elif replied:
        user = await replied.get_sender()
    else:
        return await send_response(event, "‚ö†Ô∏è **–ö–æ–º–∞–Ω–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å @username**")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    can_moderate, reason = await can_use_moderation(event.chat_id, event.sender_id)
    if not can_moderate:
        return await send_response(event, f"‚õîÔ∏è **{reason}**")
    
    args = event.pattern_match
    time_str = args.group(4).lower()
    reason_text = args.group(5) or "–ù–µ —É–∫–∞–∑–∞–Ω–∞"
    
    duration_match = re.match(r"(\d+)([–¥–º—áh])", time_str)
    if not duration_match:
        return await send_response(
            event,
            "‚ö†Ô∏è **–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏**\n\n"
            "**–ü—Ä–∏–º–µ—Ä—ã:**\n"
            "30–º - 30 –º–∏–Ω—É—Ç\n"
            "2—á - 2 —á–∞—Å–∞\n"
            "1–¥ - 1 –¥–µ–Ω—å"
        )
    
    amount = int(duration_match.group(1))
    unit = duration_match.group(2)
    
    if unit in ["–º", "m"]:
        duration_minutes = amount
        duration_text = f"{amount} –º–∏–Ω—É—Ç"
    elif unit in ["—á", "h"]:
        duration_minutes = amount * 60
        duration_text = f"{amount} —á–∞—Å–æ–≤"
    elif unit in ["–¥", "d"]:
        duration_minutes = amount * 1440
        duration_text = f"{amount} –¥–Ω–µ–π"
    else:
        return await send_response(event, "‚ö†Ô∏è **–ù–µ–≤–µ—Ä–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –≤—Ä–µ–º–µ–Ω–∏**")
    
    success, message = await mute_user_in_chat(
        event.chat_id,
        user.id,
        duration_minutes=duration_minutes,
        reason=reason_text
    )
    
    if success:
        mute_text = f"üìõ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.first_name} (`{user.id}`) –±—ã–ª –≤—ã–¥–∞–Ω –º—É—Ç –Ω–∞ {duration_text}!**"
        
        keyboard = [
            [Button.inline("üïê –°–Ω—è—Ç—å –º—É—Ç", f"unmute_{user.id}")],
            [Button.url("üëì –ß–∞—Ç –¥–ª—è –æ—Ñ—Ñ—Ç–æ–ø–∞", "https://t.me/WARDREPORT")],
            [Button.url("üìã –õ–æ–≥–∏", LOG_CHANNEL)]
        ]
        
        await send_response(event, mute_text, buttons=keyboard)
    else:
        await send_response(event, f"‚ùå **–û—à–∏–±–∫–∞:** {message}")


@bot.on(events.NewMessage(pattern=r'(?i)^(/|\.)?(unmute|–∞–Ω–º—É—Ç)(@\w+)?'))
async def unmute_handler(event):
    """–†–∞–∑–º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    username = event.pattern_match.group(3)
    replied = await event.get_reply_message() if not username else None
    
    if username:
        try:
            user = await bot.get_entity(username)
        except:
            return await send_response(event, "‚ö†Ô∏è **–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**")
    elif replied:
        user = await replied.get_sender()
    else:
        return await send_response(event, "‚ö†Ô∏è **–ö–æ–º–∞–Ω–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å @username**")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    can_moderate, reason = await can_use_moderation(event.chat_id, event.sender_id)
    if not can_moderate:
        return await send_response(event, f"‚õîÔ∏è **{reason}**")
    
    success, message = await unmute_user_in_chat(event.chat_id, user.id)
    
    if success:
        unmute_text = f"üîä **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.first_name} —Ä–∞–∑–º—É—á–µ–Ω!**\n\nüë§ **–°–Ω—è–ª –º—É—Ç:** {event.sender.first_name}"
        
        keyboard = [
            [Button.url("üëë –ß–∞—Ç –¥–ª—è –æ—Ñ—Ñ—Ç–æ–ø–∞", "https://t.me/WARDREPORT")],
            [Button.url("üìã –õ–æ–≥–∏", LOG_CHANNEL)]
        ]
        
        await send_response(event, unmute_text, buttons=keyboard)
    else:
        await send_response(event, f"‚ùå **–û—à–∏–±–∫–∞:** {message}")


@bot.on(events.NewMessage(pattern=r'(?i)^(/|\.)?(ban|–±–∞–Ω)(@\w+)?\s*(\d+[–¥–º—áh])\s*(.*)'))
async def ban_handler(event):
    """–ë–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    username = event.pattern_match.group(3)
    replied = await event.get_reply_message() if not username else None
    
    if username:
        try:
            user = await bot.get_entity(username)
        except:
            return await send_response(event, "‚ö†Ô∏è **–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**")
    elif replied:
        user = await replied.get_sender()
    else:
        return await send_response(event, "‚ö†Ô∏è **–ö–æ–º–∞–Ω–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å @username**")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    can_moderate, reason = await can_use_moderation(event.chat_id, event.sender_id)
    if not can_moderate:
        return await send_response(event, f"‚õîÔ∏è **{reason}**")
    
    args = event.pattern_match
    time_str = args.group(4).lower()
    reason_text = args.group(5) or "–ù–µ —É–∫–∞–∑–∞–Ω–∞"
    
    duration_match = re.match(r"(\d+)([–¥–º—áh])", time_str)
    if not duration_match:
        return await send_response(
            event,
            "‚ö†Ô∏è **–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏**\n\n"
            "**–ü—Ä–∏–º–µ—Ä—ã:**\n"
            "30–º - 30 –º–∏–Ω—É—Ç\n"
            "2—á - 2 —á–∞—Å–∞\n"
            "1–¥ - 1 –¥–µ–Ω—å"
        )
    
    amount = int(duration_match.group(1))
    unit = duration_match.group(2)
    
    if unit in ["–º", "m"]:
        duration_minutes = amount
        duration_text = f"{amount} –º–∏–Ω—É—Ç"
    elif unit in ["—á", "h"]:
        duration_minutes = amount * 60
        duration_text = f"{amount} —á–∞—Å–æ–≤"
    elif unit in ["–¥", "d"]:
        duration_minutes = amount * 1440
        duration_text = f"{amount} –¥–Ω–µ–π"
    
    success, message = await ban_user_in_chat(
        event.chat_id,
        user.id,
        duration_minutes=duration_minutes,
        reason=reason_text
    )
    
    if success:
        ban_text = f"üìõ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.first_name} (`{user.id}`) –≤—ã–¥–∞–Ω –±–∞–Ω –Ω–∞ {duration_text}!**\nüìù **–ü—Ä–∏—á–∏–Ω–∞:** {reason_text}"
        
        keyboard = [
            [Button.inline("üîì –°–Ω—è—Ç—å –±–∞–Ω", f"unban_{user.id}")],
            [Button.url("üí≠ –ß–∞—Ç –¥–ª—è –æ—Ñ—Ñ—Ç–æ–ø–∞", "https://t.me/WARDREPORT")],
            [Button.url("üìã –õ–æ–≥–∏", LOG_CHANNEL)]
        ]
        
        await send_response(event, ban_text, buttons=keyboard)
    else:
        await send_response(event, f"‚ùå **–û—à–∏–±–∫–∞:** {message}")


@bot.on(events.NewMessage(pattern=r'(?i)^(/|\.)?(unban|—Ä–∞–∑–±–∞–Ω)(@\w+)?'))
async def unban_handler(event):
    """–†–∞–∑–±–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    username = event.pattern_match.group(3)
    replied = await event.get_reply_message() if not username else None
    
    if username:
        try:
            user = await bot.get_entity(username)
        except:
            return await send_response(event, "‚ö†Ô∏è **–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**")
    elif replied:
        user = await replied.get_sender()
    else:
        return await send_response(event, "‚ö†Ô∏è **–ö–æ–º–∞–Ω–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å @username**")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    can_moderate, reason = await can_use_moderation(event.chat_id, event.sender_id)
    if not can_moderate:
        return await send_response(event, f"‚õîÔ∏è **{reason}**")
    
    success, message = await unban_user_in_chat(event.chat_id, user.id)
    
    if success:
        unban_text = f"üí´ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.first_name} (`{user.id}`) —Ä–∞–∑–±–∞–Ω–µ–Ω!**\nüëÆ **–°–Ω—è–ª –±–∞–Ω:** {event.sender.first_name}"
        
        keyboard = [
            [Button.url("üí≠ –ß–∞—Ç –¥–ª—è –æ—Ñ—Ñ—Ç–æ–ø–∞", "https://t.me/WARDREPORT")],
            [Button.url("üìã –õ–æ–≥–∏", LOG_CHANNEL)]
        ]
        
        await send_response(event, unban_text, buttons=keyboard)
    else:
        await send_response(event, f"‚ùå **–û—à–∏–±–∫–∞:** {message}")


# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò CALLBACK ==========

@bot.on(events.CallbackQuery(data=b"hide_message"))
async def hide_message_handler(event):
    """–°–∫—Ä—ã—Ç–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    try:
        await event.delete()
    except:
        pass


@bot.on(events.CallbackQuery(pattern=r'mark_(scammer|possible|suspect|rooster)_(\d+)_(.+)'))
async def mark_user_handler(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏ –¥–ª—è —Å–∫–∞–º–º–µ—Ä–∞"""
    role_type = event.pattern_match.group(1)
    user_id = int(event.pattern_match.group(2))
    
    role_mapping = {
        'scammer': 3,
        'possible': 2,
        'suspect': 5,
        'rooster': 4
    }
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
    user_role = db.get_user_role(event.sender_id)
    if user_role not in [1, 6, 8, 10, 11, 9] and event.sender_id not in OWNER_ID:
        return await event.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤!", alert=True)
    
    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–∏
    db.update_role(user_id, role_mapping[role_type])
    
    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–∫–∞–º–º–µ—Ä–æ–≤ –¥–ª—è —Ç–æ–≥–æ, –∫—Ç–æ –æ—Ç–º–µ—Ç–∏–ª
    db.increment_scammers_count(event.sender_id)
    scammers_slept = db.get_user_scammers_slept(event.sender_id)
    
    await event.answer(f"‚úÖ –†–æ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞! –°–∫–∞–º–º–µ—Ä–æ–≤ —Å–ª–∏—Ç–æ: {scammers_slept}", alert=True)
    await event.delete()


@bot.on(events.CallbackQuery(pattern='about_project'))
async def about_project(event):
    """–û –ø—Ä–æ–µ–∫—Ç–µ"""
    about_text = (
        "–ú—ã - –≥–ª–æ–±–∞–ª—å–Ω–∞—è –∞–Ω—Ç–∏—Å–∫–∞–º –±–∞–∑–∞ WARD ANTISCAM. "
        "–ù–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª –ø–æ–º–æ–≥–∞–µ—Ç –∫–æ–º—å—é–Ω–∏—Ç–∏ –±–æ—Ä–æ—Ç—å—Å—è —Å–æ —Å–∫–∞–º–æ–º. "
        "–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –ø–∏—à–∏—Ç–µ, —Å —Ä–∞–¥–æ—Å—Ç—å—é –ø–æ–º–æ–∂–µ–ºü§ó"
        "[‚†Ä](https://i.ibb.co/S40fy8Kx/temp-5173733679-1327.jpg)"
    )
    
    buttons = [
        [Button.inline("ü§î –ö–∞–∫ —Å—Ç–∞—Ç—å –≥–∞—Ä–∞–Ω—Ç–æ–º?", "how_to_become_guarantor")],
        [Button.inline("ü§ë –£ –∫–æ–≥–æ –∏ –∫–∞–∫ –∫—É–ø–∏—Ç—å —Ç—Ä–∞—Å—Ç?", "how_to_buy_trust")],
        [Button.inline("üòà –ö–∞–∫ —Å–ª–∏—Ç—å –≤–∞–º —Å–∫–∞–º–º–µ—Ä–∞?", "how_to_report_scammer")]
    ]
    
    await event.edit(about_text, buttons=buttons, link_preview=True)


@bot.on(events.CallbackQuery(pattern='support_handler'))
async def support_handler(event):
    """–ü–æ–¥–¥–µ—Ä–∂–∫–∞"""
    support_text = (
        "–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Ä–∞–∑–≤–∏—Ç–∏–µ –±–æ—Ç–∞, "
        "–≤—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏:\n\n"
        "TTD –Ω–∏–∫: **RYWUEEHWI**"
        "[‚†Ä](https://i.ibb.co/0x7KTr0/image.jpg)"
    )
    
    buttons = [
        [Button.url("üíå –ö—Ä–∏–ø—Ç–æ –±–æ—Ç–æ–º", "https://t.me/send?start=IVdGVHgwlEsa")],
        [Button.url("üíû –ù–∞—à –∫–æ–¥–µ—Ä", "https://t.me/XOMTG")]
    ]
    
    await event.edit(support_text, buttons=buttons, link_preview=True)


@bot.on(events.CallbackQuery(pattern='creator'))
async def creator_handler(event):
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞—Ç–µ–ª—è—Ö"""
    await event.edit("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞—Ç–µ–ª—è—Ö:\n–°–æ–∑–¥–∞—Ç–µ–ª—å - @XOMTG\n–ö–æ–¥–µ—Ä - @XOMTG")


@bot.on(events.CallbackQuery(pattern='add_group'))
async def add_group_handler(event):
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É"""
    url = "https://t.me/WARDANTISCAM_bot?startgroup=newgroup&admin=manage_chat+delete_messages+restrict_members+invite_users+restrict_members+change_info+pin_messages+manage_video_chats"
    keyboard = types.KeyboardButtonUrl(text="–î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É", url=url)
    await event.edit("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É:", buttons=keyboard)


@bot.on(events.CallbackQuery(pattern='report_scammer'))
async def report_handler(event):
    """–ñ–∞–ª–æ–±–∞ –Ω–∞ —Å–∫–∞–º–º–µ—Ä–∞"""
    await event.respond(
        "–î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å–∫–∞–º–º–µ—Ä–∞, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—à "
        "[—Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —á–∞—Ç](https://t.me/WARDREPORT)\n"
        "–í–∞–º –Ω—É–∂–Ω—ã –ø—Ä—É—Ñ—ã –∏ —Å–∫—Ä–∏–Ω—ã –ø–µ—Ä–µ–ø–∏—Å–æ–∫!"
    )


@bot.on(events.CallbackQuery(pattern=r'check_(\d+)'))
async def check_callback_handler(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ callback"""
    user_id = int(event.data.decode().split('_')[1])
    try:
        user = await bot.get_entity(user_id)
        user_data = db.get_user(user_id)
        message_text, buttons = await get_user_profile_response(event, user, user_data)
        await event.respond(message_text, buttons=buttons, link_preview=True)
    except:
        await event.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ", alert=True)


@bot.on(events.CallbackQuery(pattern='check_soon'))
async def check_soon_handler(event):
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–±—è —á–µ—Ä–µ–∑ callback"""
    user = await event.client.get_entity(event.sender_id)
    user_id = user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_data = db.get_user(user_id)
    role_id = db.get_user_role(user_id)
    role_info = ROLES[role_id]
    
    checks_count = db.get_check_count(user_id)
    current_time = datetime.now()
    
    custom_photo = db.get_user_custom_photo(user_id)
    preview_url = custom_photo if custom_photo else role_info['preview_url']
    
    response = (
        f"üë§ | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: [{user.first_name}](tg://user/{user.id})\n\n"
        f"üîç | ID: `{user.id}`\n\n"
        f"ü§ó | –†–æ–ª—å –≤ –±–∞–∑–µ: {role_info['name']}\n\n"
        f"‚öñ | –®–∞–Ω—Å —Å–∫–∞–º–∞: {role_info['scam_chance']}%\n\n"
        f"üìÖ {current_time.strftime('%d.%m.%Y')} | üîç {checks_count}\n\n"
        f"[–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–µ–¥–∏–∞]({preview_url})"
    )
    
    buttons = [
        [
            Button.url("üë§ –ü—Ä–æ—Ñ–∏–ª—å", f"https://t.me/{user.username}" if user.username else f"tg://user?id={user.id}"),
            Button.url("üîó –°—Å—ã–ª–∫–∞", f"https://t.me/{user.username}" if user.username else f"tg://user?id={user.id}")
        ],
        [
            Button.url("‚ö†Ô∏è –°–ª–∏—Ç—å —Å–∫–∞–º–º–µ—Ä–∞", "https://t.me/WARDREPORT"),
            Button.inline("‚öñÔ∏è –ê–ø–ø–µ–ª—è—Ü–∏—è", "appeal")
        ]
    ]
    
    await event.edit(response, buttons=buttons)


@bot.on(events.CallbackQuery(pattern='country_soon'))
async def country_soon_handler(event):
    """–í—ã–±–æ—Ä —Å—Ç—Ä–∞–Ω—ã"""
    countries = [
        "–°–®–ê üá∫üá∏", "–ö–∞–Ω–∞–¥–∞ üá®üá¶", "–ú–µ–∫—Å–∏–∫–∞ üá≤üáΩ", "–ë—Ä–∞–∑–∏–ª–∏—è üáßüá∑",
        "–ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞ üá¶üá∑", "–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è üá¨üáß", "–§—Ä–∞–Ω—Ü–∏—è üá´üá∑",
        "–ì–µ—Ä–º–∞–Ω–∏—è üá©üá™", "–ò—Ç–∞–ª–∏—è üáÆüáπ", "–ò—Å–ø–∞–Ω–∏—è üá™üá∏", "–ö–∏—Ç–∞–π üá®üá≥",
        "–Ø–ø–æ–Ω–∏—è üáØüáµ", "–ê–≤—Å—Ç—Ä–∞–ª–∏—è üá¶üá∫", "–ò–Ω–¥–∏—è üáÆüá≥", "–†–æ—Å—Å–∏—è üá∑üá∫"
    ]
    
    buttons = [Button.inline(country, f"set_country_{i}") for i, country in enumerate(countries)]
    
    await event.respond(
        "üåç –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É, –≤—ã–±—Ä–∞–Ω–Ω–∞—è –≤–∞–º–∏ —Å—Ç—Ä–∞–Ω–∞ –±—É–¥–µ—Ç —Å—Ç–æ—è—Ç—å —É –≤–∞—Å –≤ –ø—Ä–æ—Ñ–∏–ª–µ!",
        buttons=[buttons[i:i + 3] for i in range(0, len(buttons), 3)]
    )


@bot.on(events.CallbackQuery(pattern=r'set_country_(\d+)'))
async def set_country_handler(event):
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç—Ä–∞–Ω—ã"""
    country_idx = int(event.data.decode().split('_')[2])
    countries = [
        "–°–®–ê üá∫üá∏", "–ö–∞–Ω–∞–¥–∞ üá®üá¶", "–ú–µ–∫—Å–∏–∫–∞ üá≤üáΩ", "–ë—Ä–∞–∑–∏–ª–∏—è üáßüá∑",
        "–ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞ üá¶üá∑", "–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è üá¨üáß", "–§—Ä–∞–Ω—Ü–∏—è üá´üá∑",
        "–ì–µ—Ä–º–∞–Ω–∏—è üá©üá™", "–ò—Ç–∞–ª–∏—è üáÆüáπ", "–ò—Å–ø–∞–Ω–∏—è üá™üá∏", "–ö–∏—Ç–∞–π üá®üá≥",
        "–Ø–ø–æ–Ω–∏—è üáØüáµ", "–ê–≤—Å—Ç—Ä–∞–ª–∏—è üá¶üá∫", "–ò–Ω–¥–∏—è üáÆüá≥", "–†–æ—Å—Å–∏—è üá∑üá∫"
    ]
    
    country = countries[country_idx]
    user_id = event.sender_id
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if not db.user_exists(user_id):
        db.add_user(user_id, None)
    
    db.update_user(user_id, country=country)
    await event.answer(f"‚úÖ –°—Ç—Ä–∞–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: {country}", alert=True)


@bot.on(events.CallbackQuery(pattern='channel_soon'))
async def channel_soon_handler(event):
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–Ω–∞–ª–∞"""
    user_id = event.sender_id
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–º–∏—É–º-—Å—Ç–∞—Ç—É—Å–∞
    if not db.is_premium_user(user_id):
        return await event.answer(
            "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å–∞! –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–Ω–∞–ª–∞ –ø—Ä–∏–æ–±—Ä–µ—Ç–∏—Ç–µ –ø—Ä–µ–º–∏—É–º.",
            alert=True
        )
    
    await event.respond("–û—Ç–ø—Ä–∞–≤—å—Ç–µ username –∫–∞–Ω–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, @channelname)")
    
    @bot.on(events.NewMessage(from_users=user_id))
    async def channel_handler(channel_event):
        channel_name = channel_event.text.strip()
        if not channel_name.startswith('@'):
            await channel_event.reply("‚ùå –ò–º—è –∫–∞–Ω–∞–ª–∞ –¥–æ–ª–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å @")
        elif len(channel_name) > 32:
            await channel_event.reply("‚ùå –ò–º—è –∫–∞–Ω–∞–ª–∞ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å. 32 —Å–∏–º–≤–æ–ª–∞)")
        else:
            db.update_user(channel_event.sender_id, channel=channel_name)
            await channel_event.reply(f"‚úÖ –ö–∞–Ω–∞–ª {channel_name} —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!")
        bot.remove_event_handler(channel_handler)


@bot.on(events.CallbackQuery(pattern='custom_soon'))
async def custom_soon_handler(event):
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ñ–æ—Ç–æ"""
    user_id = event.sender_id
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–º–∏—É–º-—Å—Ç–∞—Ç—É—Å–∞
    if not db.is_premium_user(user_id):
        return await event.answer(
            "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å–∞! –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ñ–æ—Ç–æ –ø—Ä–∏–æ–±—Ä–µ—Ç–∏—Ç–µ –ø—Ä–µ–º–∏—É–º.",
            alert=True
        )
    
    await event.respond("–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –≤–∏–¥–µ–æ")
    
    @bot.on(events.NewMessage(from_users=user_id))
    async def media_handler(media_event):
        if media_event.photo or media_event.video:
            try:
                media_path = await bot.download_media(media_event.photo or media_event.video)
                
                if media_event.photo:
                    with open(media_path, "rb") as image_file:
                        files = {"image": image_file}
                        params = {"key": IMG_API_KEY}
                        response = requests.post(
                            "https://api.imgbb.com/1/upload",
                            params=params,
                            files=files
                        )
                        response.raise_for_status()
                        data = response.json()
                    
                    os.remove(media_path)
                    
                    if data.get("success") and "data" in data and "url" in data["data"]:
                        image_url = data["data"]["url"]
                        db.cursor.execute(
                            'UPDATE users SET custom_photo_url = ? WHERE user_id = ?',
                            (image_url, user_id)
                        )
                        db.conn.commit()
                        await media_event.reply(f"‚úÖ –ö–∞—Å—Ç–æ–º–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!")
                    else:
                        await media_event.reply("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.")
                
                elif media_event.video:
                    video_url = f"https://t.me/WARDANTISCAM_bot?start=video_{media_event.video.id}"
                    db.cursor.execute(
                        'UPDATE users SET custom_photo_url = ? WHERE user_id = ?',
                        (video_url, user_id)
                    )
                    db.conn.commit()
                    await media_event.reply(f"‚úÖ –ö–∞—Å—Ç–æ–º–Ω–æ–µ –≤–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!")
            
            except Exception as e:
                await media_event.reply(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}")
        else:
            await media_event.reply("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –≤–∏–¥–µ–æ.")
        
        bot.remove_event_handler(media_handler)


@bot.on(events.CallbackQuery(pattern='remove_custom'))
async def remove_custom_handler(event):
    """–£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ñ–æ—Ç–æ"""
    user_id = event.sender_id
    db.cursor.execute('UPDATE users SET custom_photo_url = NULL WHERE user_id = ?', (user_id,))
    db.conn.commit()
    await event.answer("‚úÖ –ö–∞—Å—Ç–æ–º–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ.", alert=True)


@bot.on(events.CallbackQuery(pattern=r'buy_(premium|rest)_(\d+)([–¥–Ω–º])'))
async def purchase_handler(event):
    """–ü–æ–∫—É–ø–∫–∞ –≤ –º–∞–≥–∞–∑–∏–Ω–µ"""
    action = event.pattern_match.group(1)
    amount = int(event.pattern_match.group(2))
    unit = event.pattern_match.group(3)
    
    user_id = event.sender_id
    balance = db.get_premium_points(user_id)
    
    cost_mapping = {
        'premium_1–¥': 10,
        'premium_7–¥': 50,
        'premium_30–¥': 125,
        'rest_1–¥': 100
    }
    
    data_str = event.data.decode('utf-8')
    cost = cost_mapping.get(data_str)
    
    if not cost:
        return await event.answer("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞.", alert=True)
    
    if balance >= cost:
        db.add_premium_points(user_id, -cost)
        
        if action == 'premium':
            if unit == '–¥':
                days = amount
            elif unit == '–Ω':
                days = amount * 7
            elif unit == '–º':
                days = amount * 30
            
            expiry_date = (datetime.now() + timedelta(days=days)).strftime("%Y-%m-%d %H:%M:%S")
            db.add_premium(user_id, expiry_date)
            await event.answer(f"‚úÖ –ü—Ä–µ–º–∏—É–º –Ω–∞ {amount}{unit} —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω!", alert=True)
        else:
            await event.answer("‚úÖ –û—Ç–¥—ã—Ö —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω!", alert=True)
    else:
        await event.answer("‚ùå –£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤!", alert=True)


@bot.on(events.CallbackQuery(pattern=r'search_again_(\d+)'))
async def search_again_handler(event):
    """–ü–æ–∏—Å–∫ —Å–Ω–æ–≤–∞"""
    await event.answer("–î–∞ –º–Ω–µ –ª–µ–Ω—å —Ä–∞–±–æ—Ç–∞—Ç—å —á—ë-—Ç–æü•±ü•±", alert=True)


@bot.on(events.CallbackQuery(pattern=r'sell_something_(\d+)'))
async def sell_something_handler(event):
    """–ü—Ä–æ–¥–∞—Ç—å —á—Ç–æ-—Ç–æ"""
    await event.answer("–ù–∞–ø–∏—à–∏ '–ø—Ä–æ–¥–∞—Ç—å (—á—Ç–æ-—Ç–æ —Ç–≤–æ—ë)'", alert=True)


@bot.on(events.CallbackQuery(pattern=r'unmute_(\d+)'))
async def unmute_callback_handler(event):
    """–†–∞–∑–º—É—Ç —á–µ—Ä–µ–∑ callback"""
    user_id = int(event.data.decode().split('_')[1])
    
    can_moderate, reason = await can_use_moderation(event.chat_id, event.sender_id)
    if not can_moderate:
        return await event.answer(f"‚õîÔ∏è {reason}", alert=True)
    
    success, message = await unmute_user_in_chat(event.chat_id, user_id)
    
    if success:
        await event.answer("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–º—É—á–µ–Ω!", alert=True)
        await event.delete()
    else:
        await event.answer(f"‚ùå {message}", alert=True)


@bot.on(events.CallbackQuery(pattern=r'unban_(\d+)'))
async def unban_callback_handler(event):
    """–†–∞–∑–±–∞–Ω —á–µ—Ä–µ–∑ callback"""
    user_id = int(event.data.decode().split('_')[1])
    
    can_moderate, reason = await can_use_moderation(event.chat_id, event.sender_id)
    if not can_moderate:
        return await event.answer(f"‚õîÔ∏è {reason}", alert=True)
    
    success, message = await unban_user_in_chat(event.chat_id, user_id)
    
    if success:
        await event.answer("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–∞–Ω–µ–Ω!", alert=True)
        await event.delete()
    else:
        await event.answer(f"‚ùå {message}", alert=True)


@bot.on(events.CallbackQuery(pattern=r'ban_(\d+)'))
async def ban_callback_handler(event):
    """–ë–∞–Ω —á–µ—Ä–µ–∑ callback"""
    user_id = int(event.data.decode().split('_')[1])
    
    can_moderate, reason = await can_use_moderation(event.chat_id, event.sender_id)
    if not can_moderate:
        return await event.answer(f"‚õîÔ∏è {reason}", alert=True)
    
    success, message = await ban_user_in_chat(event.chat_id, user_id, duration_minutes=1440)
    
    if success:
        await event.answer("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω –Ω–∞ 24 —á–∞—Å–∞!", alert=True)
        await event.delete()
    else:
        await event.answer(f"‚ùå {message}", alert=True)


@bot.on(events.CallbackQuery(data=b"top_trainees"))
async def top_trainees_handler(event):
    """–¢–æ–ø —Å—Ç–∞–∂–µ—Ä–æ–≤"""
    try:
        top_trainees = db.cursor.execute('''
            SELECT user_id, username, scammers_slept 
            FROM users 
            WHERE role_id = 6 
            ORDER BY scammers_slept DESC 
            LIMIT 10
        ''').fetchall()
        
        if not top_trainees:
            return await event.respond("üì≠ –°–ø–∏—Å–æ–∫ —Å—Ç–∞–∂–µ—Ä–æ–≤ –ø–æ–∫–∞ –ø—É—Å—Ç!")
        
        response = "üèÜ –¢–æ–ø 10 —Å—Ç–∞–∂–µ—Ä–æ–≤ –ø–æ —Å–ª–∏—Ç—ã–º —Å–∫–∞–º–º–µ—Ä–∞–º:\n\n"
        for i, (user_id, username, count) in enumerate(top_trainees, 1):
            user_link = f"[{username or f'ID:{user_id}'}](tg://user?id={user_id})"
            response += f"{i}. {user_link} ‚Äî üö´ {count} —Å–∫–∞–º–º–µ—Ä–æ–≤\n"
        
        await event.edit(response, parse_mode='Markdown')
    except Exception as e:
        await event.respond(f"‚ö†Ô∏è –û—à–∏–±–∫–∞: {str(e)}")


@bot.on(events.CallbackQuery(data=b"top_day"))
async def top_day_handler(event):
    """–¢–æ–ø –∞–∫—Ç–∏–≤–Ω—ã—Ö"""
    day_ago = (datetime.now() - timedelta(days=1)).strftime('%Y-%m-%d %H:%M:%S')
    
    try:
        db.cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='messages'")
        if not db.cursor.fetchone():
            return await event.respond("‚ö†Ô∏è –¢–∞–±–ª–∏—Ü–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞. –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è.")
        
        top_users = db.cursor.execute('''
            SELECT u.user_id, u.username, COUNT(m.id) as count
            FROM users u
            JOIN messages m ON u.user_id = m.user_id
            WHERE m.timestamp > ?
            GROUP BY u.user_id
            ORDER BY count DESC
            LIMIT 10
        ''', (day_ago,)).fetchall()
        
        if not top_users:
            return await event.respond("üì≠ –ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞!")
        
        response = "üòé –¢–æ–ø 10 –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ 24 —á–∞—Å–∞:\n\n"
        for i, (user_id, username, count) in enumerate(top_users, 1):
            username = f"@{username}" if username else f"ID:{user_id}"
            response += f"{i}. {username} ‚Äî ‚úâÔ∏è {count} —Å–æ–æ–±—â–µ–Ω–∏–π\n"
        
        await event.edit(response)
    except Exception as e:
        await event.respond(f"‚ö†Ô∏è –û—à–∏–±–∫–∞: {str(e)}")


@bot.on(events.CallbackQuery(pattern=r'how_to_(become_guarantor|buy_trust|report_scammer)'))
async def faq_handler(event):
    """FAQ –æ—Ç–≤–µ—Ç—ã"""
    faq_type = event.pattern_match.group(1)
    
    if faq_type == 'become_guarantor':
        response = (
            "–ß—Ç–æ–±—ã —Å—Ç–∞—Ç—å –≥–∞—Ä–∞–Ω—Ç–æ–º, –Ω—É–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –Ω–∞–±–æ—Ä –≤ –Ω–∞—à—É –±–∞–∑—É. "
            "–í–ª–∞–¥–µ–ª—å—Ü—ã —Ä–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–æ–¥—è—Ç –Ω–∞–±–æ—Ä—ã –Ω–∞ –º–Ω–æ–≥–∏–µ —Ä–æ–ª–∏, –≤ —Ç–æ–º —á–∏—Å–ª–µ –≥–∞—Ä–∞–Ω—Ç–æ–≤. "
            "–ï—Å–ª–∏ —Ç—ã —Ö–æ—á–µ—à—å —Å—Ç–∞—Ç—å –≥–∞—Ä–∞–Ω—Ç–æ–º, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–π–¥–∏ –Ω–∞–±–æ—Ä –≤ –Ω–∞—à—É –±–∞–∑—Éü§ó"
        )
    elif faq_type == 'buy_trust':
        response = (
            "–•–æ—á–µ—à—å –∫—É–ø–∏—Ç—å —Ç—Ä–∞—Å—Ç? –î–∞ —Ç—ã –±–æ–≥–∞—áü§ó. –ß—Ç–æ–±—ã –∫—É–ø–∏—Ç—å —Ç—Ä–∞—Å—Ç, —Ç–µ–±–µ –Ω—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–∞—à–∏–º –≥–∞—Ä–∞–Ω—Ç–∞–º "
            "–ì–∞—Ä–∞–Ω—Ç–æ–≤ —Ç—ã –º–æ–∂–µ—à—å –Ω–∞–π—Ç–∏ –≤ —á–∞—Ç–µ –∏–ª–∏ –∂–µ –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É '–ì–∞—Ä–∞–Ω—Ç—ã' –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—éü§ë"
        )
    elif faq_type == 'report_scammer':
        response = (
            "–û—Ö, —Ç–µ–±—è —Ç–æ–∂–µ –∑–∞–¥—Ä–∞–ª–∏ —Å–∫–∞–º–º–µ—Ä—ã? –ú–µ–Ω—è —Ç–æ–∂–µüò° –ï—Å–ª–∏ —Ç—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—á–µ—à—å —Å–ª–∏—Ç—å —Å–∫–∞–º–º–µ—Ä–∞, "
            "—Ç–æ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –∑–∞–π—Ç–∏ –≤ –Ω–∞—à—É –±–∞–∑—É –∏ –Ω–∞–ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ —Å–∫–∞–º–∞ –∏ —é–∑–µ—Ä–Ω–µ–π–º-–∞–π–¥–∏. "
            "–ù–∞—à–∏ –≤–æ–ª–æ–Ω—Ç—ë—Ä—ã –∑–∞–Ω–µ—Å—É—Ç —ç—Ç–æ–≥–æ —Å–∫–∞–º–º–µ—Ä–∞üòà"
        )
    
    await event.respond(response)


@bot.on(events.CallbackQuery(pattern='appeal'))
async def appeal_handler(event):
    """–ê–ø–µ–ª–ª—è—Ü–∏—è"""
    await event.answer("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è!", alert=True)
    await event.client.send_message(
        event.sender_id,
        "–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ–±–∂–∞–ª–æ–≤–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ —Å—á—ë—Ç –∑–∞–Ω–æ—Å–∞ –≤–∞—Å –≤ –±–∞–∑—É, –≤–æ—Ç —á—Ç–æ –≤–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞—Ç—å!\n"
        "1Ô∏è‚É£ –ü–µ—Ä–µ–π—Ç–∏ –≤ –Ω–∞—à—É –ø—Ä–µ–¥–ª–æ–∂–∫—É WARD!\n"
        "2Ô∏è‚É£ –û–ø–∏—Å–∞—Ç—å —Å–≤–æ—é –ø—Ä–æ–±–ª–µ–º—É –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ —Ç–æ–≥–æ, —á—Ç–æ –≤—ã –Ω–µ –æ–±–º–∞–Ω—ã–≤–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!\n"
        "3Ô∏è‚É£ –û–∂–∏–¥–∞—Ç—å –æ—Ç–≤–µ—Ç–∞ –æ—Ç –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤!\n\n"
        "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –≤—ã–±—Ä–∞–ª–∏ –±–∞–∑—É WARD ANTISCAM, –º—ã –æ—á–µ–Ω—å —Ü–µ–Ω–∏–º –Ω–∞—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!"
    )


# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö –ß–ê–¢–û–í ==========

@bot.on(events.ChatAction)
async def handle_chat_join(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç"""
    if not (event.user_joined or event.user_added):
        return
    
    user = await event.get_user()
    user_id = user.id
    
    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –±–æ—Ç–æ–≤
    if user.bot:
        return
    
    # –ö—ç—à –æ—Ç –ø–æ–≤—Ç–æ—Ä–æ–≤
    if user_id in joined_users_cache:
        return
    joined_users_cache.add(user_id)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if not db.user_exists(user_id):
        db.add_user(user_id, user.username)
    
    # –ü–æ–ª—É—á–∞–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_role = db.get_user_role(user_id)
    image_url = "https://i.ibb.co/Qvk5DJRY/image.jpg"
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
    if user_role == 11:  # –ö–æ–¥–µ—Ä
        text = f"""
‚òï –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! [{user.first_name}](tg://user?id={user.id})

–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!!üòä
[ü§ó]({image_url})
"""
        await event.respond(text, parse_mode='md', link_preview=True)
    
    elif user_role in [6, 7, 8, 9, 10]:  # –ü–µ—Ä—Å–æ–Ω–∞–ª
        text = f"""
‚òï –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! [{user.first_name}](tg://user?id={user.id})
[ü§ó]({image_url})
"""
        await event.respond(text, parse_mode='md', link_preview=True)
    
    elif user_role == 12:  # –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –≥–∞—Ä–∞–Ω—Ç–æ–º
        text = f"""
üî• –ö —á–∞—Ç—É –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è —á–µ–ª–æ–≤–µ–∫, –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –≥–∞—Ä–∞–Ω—Ç–æ–º WARD ANTISCAM
[ü§ó]({image_url})
"""
        await event.respond(text, parse_mode='md', link_preview=True)
    
    elif user_role == 3:  # –°–∫–∞–º–µ—Ä
        buttons = [[Button.inline("–ó–ê–ë–ê–ù–ò–¢–¨ ‚õî", f"ban_{user.id}")]]
        text = f"""
‚ö†Ô∏è –ö —á–∞—Ç—É –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è [{user.first_name}](tg://user?id={user.id}) **–°–∫–∞–º–º–µ—Ä**!

–ù–µ –¥–æ–≤–µ—Ä—è–π—Ç–µ —ç—Ç–æ–º—É —á–µ–ª–æ–≤–µ–∫—É.
[ü§ó]({image_url})
"""
        await event.respond(text, buttons=buttons, parse_mode='md', link_preview=True)
    
    elif user_role in [2, 4, 5]:  # –ü–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–µ
        buttons = [[Button.inline("–ó–ê–ë–ê–ù–ò–¢–¨ ‚õî", f"ban_{user.id}")]]
        text = f"""
‚ö†Ô∏è –ö —á–∞—Ç—É –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è [{user.first_name}](tg://user?id={user.id}) —Å –≤—ã—Å–æ–∫–∏–º —à–∞–Ω—Å–æ–º —Å–∫–∞–º–∞!

–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å–∫–∞–º–∞: {ROLES[user_role]['scam_chance']}%
[ü§ó]({image_url})
"""
        await event.respond(text, buttons=buttons, parse_mode='md', link_preview=True)
    
    else:  # –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        text = f"""
üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! [{user.first_name}](tg://user?id={user.id})
[ü§ó]({WELCOME_IMAGE})
"""
        await event.respond(text, parse_mode='md', link_preview=True)
    
    # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç
    async def clear_cache():
        await asyncio.sleep(600)
        joined_users_cache.discard(user_id)
    
    asyncio.create_task(clear_cache())


# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö –°–û–û–ë–©–ï–ù–ò–ô –î–õ–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ò ==========

@bot.on(events.NewMessage)
async def message_handler(event):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –∞–Ω—Ç–∏-—Å–ø–∞–º–∞"""
    user_id = event.sender_id
    
    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–æ–≤
    if event.sender.bot:
        return
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π
    db.update_total_messages()
    
    # –ê–Ω—Ç–∏-—Å–ø–∞–º —Å–∏—Å—Ç–µ–º–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –≥—Ä—É–ø–ø
    if event.is_group or event.is_channel:
        current_time = datetime.now()
        user_message_count[user_id].append(current_time)
        
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏
        user_message_count[user_id] = [
            timestamp for timestamp in user_message_count[user_id]
            if current_time - timestamp < timedelta(seconds=30)
        ]
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
        if len(user_message_count[user_id]) > 8:
            # –í—ã–¥–∞–µ–º –º—É—Ç –Ω–∞ 10 –º–∏–Ω—É—Ç
            try:
                success, message = await mute_user_in_chat(
                    event.chat_id,
                    user_id,
                    duration_minutes=10,
                    reason="–°–ø–∞–º"
                )
                
                if success:
                    await event.respond(f"üîá –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {event.sender.first_name} –±—ã–ª –∑–∞–º—É—á–µ–Ω –∑–∞ —Å–ø–∞–º –Ω–∞ 10 –º–∏–Ω—É—Ç!")
                    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–º—É—á–µ–Ω –∑–∞ —Å–ø–∞–º.")
                    
                    # –û—á–∏—â–∞–µ–º –∑–∞–ø–∏—Å–∏
                    del user_message_count[user_id]
                else:
                    logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–º—É—Ç–∏—Ç—å —Å–ø–∞–º–µ—Ä–∞: {message}")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –º—É—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞ —Å–ø–∞–º: {e}")


# ========== –ó–ê–ü–£–°–ö –ë–û–¢–ê ==========

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞"""
    logger.info("=" * 50)
    logger.info("–ë–æ—Ç WARD ANTISCAM –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    logger.info(f"–í–ª–∞–¥–µ–ª—å—Ü—ã: {OWNERS}")
    logger.info(f"–ê–¥–º–∏–Ω—ã: {ADMINS}")
    logger.info("=" * 50)
    
    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
        bot.start(bot_token=BOT_TOKEN)
        logger.info("–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞–º
        for owner_info in OWNERS.values():
            try:
                owner_id = int(owner_info["id"])
                bot.loop.create_task(
                    bot.send_message(
                        owner_id,
                        "‚úÖ –ë–æ—Ç WARD ANTISCAM —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!\n"
                        f"–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
                    )
                )
            except:
                pass
        
        bot.run_until_disconnected()
        
    except KeyboardInterrupt:
        logger.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
    finally:
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î
        db.close()
        logger.info("–ë–æ—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É")


if __name__ == "__main__":
    main()
